<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>poly's logmaRNGame</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            text-shadow: 0 0 20px rgba(0,212,255,0.5);
            font-size: 2.5em;
        }

        .game-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .roll-container { text-align: center; }

        .roll-display {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .roll-track {
            display: flex;
            gap: 10px;
            min-width: fit-content;
        }

        .roll-square {
            aspect-ratio: 1 / 1;
            width: calc(120px * var(--slot-scale, 1));
            height: auto;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            font-size: calc(1em * var(--slot-scale, 1));
        }

        .roll-square.acceptable {
            border-color: rgba(0,212,255,0.3);
            background: rgba(0,212,255,0.07);
        }

        .roll-square.center-acceptable {
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0,212,255,0.6);
            transform: scale(1.1);
        }

        .enchant-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .rank-name { font-size: 1.5em; font-weight: bold; margin-bottom: 8px; }
        .rank-value { font-size: 0.9em; opacity: 0.7; }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            touch-action: manipulation;
        }

        .roll-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .roll-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }

        .accept-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .accept-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(245,87,108,0.4); }

        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .pending-panel {
            background: rgba(255,215,0,0.08);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            padding: 12px 18px;
            margin: 10px 0;
            display: none;
        }
        .pending-panel.visible { display: block; }
        .pending-panel h4 { color: #ffd700; margin-bottom: 8px; font-size: 0.9em; }
        .pending-panel-orbs { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

        .bulk-info {
            font-size: 0.85em;
            color: rgba(0,212,255,0.7);
            margin-bottom: 8px;
        }

        .inventory-section h2, .stats-section h2 { margin-bottom: 15px; color: #00d4ff; }

        .inventory-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-btn { padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; font-size: 0.9em; }
        .sort-btn:hover { background: rgba(255,255,255,0.2); }

        .pagination { display: flex; gap: 10px; align-items: center; margin-left: auto; }
        .page-btn { padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; font-size: 0.9em; min-width: 40px; }
        .page-btn:hover:not(:disabled) { background: rgba(255,255,255,0.2); }
        .page-info { color: #00d4ff; font-weight: 600; }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
            position: relative;
            font-size: clamp(0.8rem, 2vw, 1.5rem);
        }

        .inventory-slot:hover { border-color: rgba(255,87,108,0.5); transform: scale(1.05); }
        .inventory-slot.empty { opacity: 0.3; cursor: default; }
        .inventory-slot.empty:hover { transform: none; border-color: rgba(255,255,255,0.1); }
        .slot-value { font-size: 1.3em; font-weight: bold; }

        .delete-checkbox {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 5;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff; }
        .stat-label { font-size: 0.9em; opacity: 0.7; margin-bottom: 5px; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #00d4ff; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00d4ff;
            text-align: center;
            max-width: 400px;
        }
        .modal-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .confirm-btn { background: #f5576c; color: white; padding: 10px 25px; }
        .cancel-btn { background: rgba(255,255,255,0.1); color: white; padding: 10px 25px; }

        .rarity-neg { color: #ff4444; text-shadow: 0 0 8px rgba(255,68,68,0.5); }
        .rarity-0 { color: #aaa; }
        .rarity-1 { color: #5dff5d; }
        .rarity-2 { color: #5dbaff; }
        .rarity-3 { color: #bd5dff; }
        .rarity-4 { color: #ff5d5d; }
        .rarity-5 { color: #ffd700; }
        .rarity-6 { color: #ff1493; }
        .rarity-7 { color: #00ffff; }
        .rarity-8 { color: #fff; text-shadow: 0 0 10px #fff; }

        .roll-square.secret-slot { border-color: rgba(187,136,255,0.5) !important; background: rgba(100,0,150,0.2) !important; }
        .roll-square.secret-slot.acceptable { border-color: rgba(187,136,255,0.8) !important; }
        .roll-square.secret-slot.center-acceptable { border-color: #bb88ff !important; box-shadow: 0 0 20px rgba(187,136,255,0.6) !important; }

        .secret-mystery-box {
            width: 100%; height: 100%;
            background: #000;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            position: absolute; top: 0; left: 0;
        }
        .secret-mystery-q {
            font-size: 2em; font-weight: 900;
            background: linear-gradient(90deg, #ff0000, #ff7700, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rainbowMove 1s linear infinite;
            user-select: none;
        }
        @keyframes rainbowMove {
            0%   { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .enchant-orb {
            width: 60px; height: 60px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2em; font-weight: bold; color: white;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            margin: 0 auto;
            overflow: hidden;
        }

        .enchant-slot {
            aspect-ratio: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border: 2px solid rgba(255,255,255,0.1);
            cursor: pointer; transition: all 0.3s;
            padding: 10px; position: relative;
        }
        .enchant-slot:hover { border-color: rgba(255,87,108,0.5); transform: scale(1.05); }
        .enchant-slot.equipped { border-color: #00d4ff; box-shadow: 0 0 15px rgba(0,212,255,0.4); }
        .enchant-slot.empty { opacity: 0.3; cursor: default; }
        .enchant-slot.empty:hover { transform: none; border-color: rgba(255,255,255,0.1); }

        .equipped-badge {
            position: absolute; top: 5px; right: 5px;
            background: #00d4ff; color: #1a1a2e;
            padding: 2px 6px; border-radius: 3px;
            font-size: 0.65em; font-weight: bold;
        }

        .equipped-enchants-section { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .equipped-enchants-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; max-width: 200px; }

        .equipped-slot {
            aspect-ratio: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border: 2px solid rgba(0,212,255,0.3);
            padding: 10px; cursor: pointer; transition: all 0.3s;
        }
        .equipped-slot:hover { border-color: rgba(0,212,255,0.6); transform: scale(1.05); }
        .equipped-slot.empty { opacity: 0.3; border-style: dashed; cursor: default; }
        .equipped-slot.empty:hover { transform: none; }

        .orb-enchants-display { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 8px; }

        .mini-enchant-orb {
            width: 35px; height: 35px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8em; font-weight: bold; color: white;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .shake-animation { animation: shake 0.2s infinite; }
        @keyframes shake {
            0%,100% { transform: translate(0,0); }
            10% { transform: translate(-5px,-5px); }
            20% { transform: translate(5px,5px); }
            30% { transform: translate(-5px,5px); }
            40% { transform: translate(5px,-5px); }
            50% { transform: translate(-5px,0); }
            60% { transform: translate(5px,0); }
            70% { transform: translate(0,-5px); }
            80% { transform: translate(0,5px); }
            90% { transform: translate(-5px,-5px); }
        }

        .delete-orb-btn {
            padding: 6px 12px; background: #f5576c; color: white;
            border: none; border-radius: 5px; cursor: pointer;
            font-size: 0.85em; margin-top: 8px;
        }
        .delete-orb-btn:hover { background: #e04555; }

        .enchant-index { }

        .enchant-type-section {
            background: rgba(0,0,0,0.2);
            padding: 15px; border-radius: 8px; margin-bottom: 15px;
        }

        .enchant-type-header {
            display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; user-select: none;
        }
        .enchant-type-header h3 { margin: 0; color: #00d4ff; font-size: 1.1em; }

        .enchant-type-content { margin-top: 10px; display: none; }
        .enchant-type-content.open { display: block; }

        .enchant-item {
            padding: 8px;
            background: rgba(255,255,255,0.05);
            margin: 5px 0; border-radius: 5px;
            display: flex; align-items: center; gap: 10px;
        }

        .enchant-item .enchant-orb { width: 40px; height: 40px; font-size: 0.9em; flex-shrink: 0; }
        .enchant-item-info { flex-grow: 1; }
        .enchant-item-name { font-weight: bold; color: #00d4ff; }
        .enchant-item-effect { font-size: 0.85em; opacity: 0.8; }
        .enchant-item-rarity { font-size: 0.75em; opacity: 0.6; }

        .joke-toggle-row {
            display: flex; align-items: center; gap: 12px;
            padding: 10px; background: rgba(255,255,100,0.06);
            border-radius: 8px; margin-bottom: 10px;
            border: 1px solid rgba(255,255,100,0.2);
        }
        .joke-toggle-label { font-size: 0.9em; color: #ffd700; }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255,255,255,0.2);
            border-radius: 24px; transition: 0.3s;
        }
        .toggle-slider:before {
            position: absolute; content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            border-radius: 50%; transition: 0.3s;
        }
        input:checked + .toggle-slider { background-color: #ffd700; }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        .secret-section .enchant-type-header h3 { color: #bb88ff; }
        .secret-item {
            padding: 8px;
            background: rgba(100,0,150,0.15);
            margin: 5px 0; border-radius: 5px;
            display: flex; align-items: center; gap: 10px;
            border: 1px solid rgba(187,136,255,0.2);
        }
        .secret-value-badge {
            min-width: 60px; height: 40px;
            background: rgba(100,0,150,0.4);
            border: 2px solid rgba(187,136,255,0.5);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #bb88ff; font-size: 0.85em;
            flex-shrink: 0;
            overflow: hidden;
        }
        .secret-item-info { flex-grow: 1; }
        .secret-item-value { font-weight: bold; color: #ff4444; }
        .secret-item-rarity { font-size: 0.8em; color: #bb88ff; }
        .secret-item-note { font-size: 0.75em; opacity: 0.6; }

        .active-effects-bar {
            background: rgba(0,212,255,0.07);
            border: 1px solid rgba(0,212,255,0.2);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: rgba(255,255,255,0.7);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .active-effect-tag {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            padding: 3px 8px;
            color: #00d4ff;
        }
        .active-effect-tag.bad { color: #ff4444; }

        @keyframes epilepsyColor {
            0%   { color: #8b0000; }
            20%  { color: #0000cc; }
            40%  { color: #ffffff; }
            60%  { color: #00ffff; }
            80%  { color: #ff0000; }
            100% { color: #8b0000; }
        }
        @keyframes epilepsyShake {
            0%   { transform: rotate(0deg); }
            33%  { transform: rotate(12.5deg); }
            66%  { transform: rotate(-12.5deg); }
            100% { transform: rotate(0deg); }
        }
        .epilepsy-text {
            animation: epilepsyColor 0.1s steps(1) infinite, epilepsyShake 0.025s linear infinite;
            font-weight: 900; font-size: 0.72em;
            display: inline-block; white-space: nowrap;
        }
        .roll-square.epilepsy-slot { border-color: rgba(255,0,0,0.5) !important; background: rgba(50,0,0,0.4) !important; }
        .roll-square.epilepsy-slot.center-acceptable { box-shadow: 0 0 20px rgba(255,0,0,0.6) !important; }
        .luck-btn { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; font-size: 0.85em !important; padding: 8px 18px !important; margin-top: 8px; }
        .luck-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(34,197,94,0.4); }
        .luck-boost-display { font-size: 0.8em; color: #22c55e; margin-top: 4px; min-height: 1.2em; }
        .secret-luck-btn { background: linear-gradient(135deg, #bb88ff 0%, #9f67ff 100%); color: white; font-size: 0.85em !important; padding: 8px 18px !important; margin-top: 8px; }
        .secret-luck-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(187,136,255,0.4); }
        .secret-luck-boost-display { font-size: 0.8em; color: #bb88ff; margin-top: 4px; min-height: 1.2em; }
        .merge-mode-btn { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: 0.85em !important; padding: 8px 16px !important; }
        .merge-mode-btn.active { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); box-shadow: 0 0 15px rgba(239,68,68,0.5); }
        .enchant-slot.selected-for-merge { border-color: #f59e0b !important; box-shadow: 0 0 20px rgba(245,158,11,0.6) !important; }
        .enchant-slot.locked { border-color: rgba(255,255,255,0.3); opacity: 0.75; }
        .locked-badge { position: absolute; top: 5px; left: 5px; background: #374151; color: #9ca3af; padding: 2px 6px; border-radius: 3px; font-size: 0.6em; font-weight: bold; }
        .merge-panel { background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; padding: 14px 18px; margin-bottom: 12px; display: none; }
        .merge-panel.visible { display: block; }
        .merge-panel h4 { color: #f59e0b; margin-bottom: 10px; }
        .merge-orbs-preview { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        .merge-orb-preview { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; min-width: 120px; text-align: center; }
        .merge-cost-info { font-size: 0.85em; color: #d1d5db; margin-bottom: 8px; }
        .merge-cost-info.no-cost { color: #ef4444; }
        .do-merge-btn { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 8px 20px; font-size: 0.95em; }
        .do-merge-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .inventory-slot.epilepsy-inv { border-color: rgba(255,0,0,0.4) !important; background: rgba(50,0,0,0.2) !important; }

        .bulk-delete-bar {
            background: rgba(255,87,108,0.1);
            border: 1px solid #f5576c;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .bulk-delete-btn { background: #f5576c; color: white; padding: 6px 16px; font-size: 0.9em; }
        .threshold-input { width: 100px; padding: 6px; background: rgba(0,0,0,0.3); border: 1px solid #f5576c; color: white; border-radius: 4px; }
        .threshold-input::placeholder { color: #aaa; }
        .exclude-secrets-label { display: flex; align-items: center; gap: 5px; font-size: 0.85em; color: #bb88ff; }

        .imaginary { filter: hue-rotate(75deg); }
        .negative { filter: hue-rotate(-100deg); }
        .imaginary.negative { filter: hue-rotate(75deg) hue-rotate(-100deg); }
    </style>
</head>
<body>
<div class="container">
    <h1>poly's logmaRNGame</h1>

    <div class="game-section roll-container">
        <div id="activeEffectsBar" class="active-effects-bar" style="display:none;"></div>
        <div id="bulkInfoLabel" class="bulk-info" style="display:none;"></div>
        <div class="roll-display" id="rollDisplay">
            <div class="roll-track" id="rollTrack"></div>
        </div>
        <div class="pending-panel" id="pendingPanel">
            <h4>‚è≥ Pending Enchants ‚Äî press Accept to collect:</h4>
            <div class="pending-panel-orbs" id="pendingPanelOrbs"></div>
        </div>
        <div class="controls">
            <button class="roll-btn" id="rollBtn">Roll</button>
            <button class="accept-btn" id="acceptBtn" disabled>Accept</button>
        </div>
        <div style="text-align:center;">
            <button class="luck-btn" id="luckBtn" onclick="clickLuckButton()">please increase my luck for the next roll!</button>
            <div class="luck-boost-display" id="luckBoostDisplay"></div>
            <button class="secret-luck-btn" id="secretLuckBtn" onclick="clickSecretLuckButton()">increase my secret luck for the next roll please!</button>
            <div class="secret-luck-boost-display" id="secretLuckBoostDisplay"></div>
        </div>
    </div>

    <div class="game-section stats-section">
        <h2>Statistics</h2>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Total Rolls</div>
                <div class="stat-value" id="totalRolls">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Accepted Ranks</div>
                <div class="stat-value" id="acceptedRanks">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Highest Rank</div>
                <div class="stat-value" id="highestRank">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Average Rank</div>
                <div class="stat-value" id="avgRank">-</div>
            </div>
            <div class="stat-box" id="brickStatBox" style="display:none;">
                <div class="stat-label">üß± Bricks (does nothing)</div>
                <div class="stat-value" id="brickCount">0</div>
            </div>
        </div>
    </div>

    <div class="game-section inventory-section">
        <h2>Inventory (60 Slots)</h2>
        <div class="inventory-controls">
            <button class="sort-btn" onclick="sortInventory('value-desc')">Sort: Highest First</button>
            <button class="sort-btn" onclick="sortInventory('value-asc')">Sort: Lowest First</button>
            <button class="sort-btn" onclick="sortInventory('newest')">Sort: Newest First</button>
            <button class="sort-btn" onclick="sortInventory('oldest')">Sort: Oldest First</button>
            <button class="sort-btn" onclick="toggleBulkDeleteMode()" id="bulkDeleteModeBtn">üóëÔ∏è Bulk Delete: OFF</button>
            <div class="pagination">
                <button class="page-btn" onclick="changePage(-1)" id="prevBtn">‚óÄ</button>
                <span class="page-info">Page <span id="currentPage">1</span> / 6</span>
                <button class="page-btn" onclick="changePage(1)" id="nextBtn">‚ñ∂</button>
            </div>
        </div>
        <div id="bulkDeleteBar" class="bulk-delete-bar" style="display:none;">
            <button class="bulk-delete-btn" onclick="deleteSelectedInventory()">Delete Selected</button>
            <div style="display:flex; gap:5px; align-items:center;">
                <input type="number" id="thresholdInput" class="threshold-input" placeholder="Threshold" value="0" step="any">
                <button class="bulk-delete-btn" onclick="deleteUnderThreshold()">Delete ‚â§ Threshold</button>
                <label class="exclude-secrets-label">
                    <input type="checkbox" id="excludeSecretsCheckbox"> Exclude secrets
                </label>
            </div>
        </div>
        <div class="inventory-grid" id="inventoryGrid"></div>
    </div>

    <div class="game-section inventory-section">
        <h2>Equipped Enchant Orb (1 Slot)</h2>
        <div class="equipped-enchants-section">
            <div class="equipped-enchants-grid" id="equippedGrid"></div>
        </div>
    </div>

    <div class="game-section inventory-section">
        <h2>Enchant Orb Inventory (30 Slots) ‚Äî Click to Equip/Unequip</h2>
        <div class="merge-panel" id="mergePanel">
            <h4>üîÄ Merge Orbs</h4>
            <div class="merge-orbs-preview" id="mergeOrbsPreview"></div>
            <div class="merge-cost-info" id="mergeCostInfo"></div>
            <button class="do-merge-btn" id="doMergeBtn" onclick="performMerge()" disabled>Merge!</button>
            <button class="cancel-btn" onclick="cancelMerge()" style="margin-left:10px;">Cancel</button>
        </div>
        <div class="inventory-controls">
            <button class="merge-mode-btn" id="mergeModeBtn" onclick="toggleMergeMode()">üîÄ Merge Mode: OFF</button>
            <button class="sort-btn" onclick="sortEnchants('tier-desc')">Sort: Highest Tier</button>
            <button class="sort-btn" onclick="sortEnchants('tier-asc')">Sort: Lowest Tier</button>
            <button class="sort-btn" onclick="sortEnchants('type')">Sort: By Type</button>
            <button class="sort-btn" onclick="sortEnchants('newest')">Sort: Newest First</button>
            <button class="sort-btn" onclick="toggleBulkDeleteEnchantMode()" id="bulkDeleteEnchantModeBtn">üóëÔ∏è Bulk Delete Ench: OFF</button>
            <div class="pagination">
                <button class="page-btn" onclick="changeEnchantPage(-1)" id="prevEnchantBtn">‚óÄ</button>
                <span class="page-info">Page <span id="currentEnchantPage">1</span> / 3</span>
                <button class="page-btn" onclick="changeEnchantPage(1)" id="nextEnchantBtn">‚ñ∂</button>
            </div>
        </div>
        <div id="bulkDeleteEnchantBar" class="bulk-delete-bar" style="display:none;">
            <button class="bulk-delete-btn" onclick="deleteSelectedEnchants()">Delete Selected Enchants</button>
        </div>
        <div class="inventory-grid" id="enchantGrid"></div>
    </div>

    <div class="game-section">
        <h2>Enchant Index</h2>
        <div class="enchant-index">

            <!-- Luck -->
            <div class="enchant-type-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('luck')">
                    <h3>üçÄ Luck Enchants</h3><span id="luck-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="luck-content">
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#4ade80;">I</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Luck I</div>
                            <div class="enchant-item-effect">+0.5x luck multiplier</div>
                            <div class="enchant-item-rarity">Rarity: 1/5 (20%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#22c55e;">II</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Luck II</div>
                            <div class="enchant-item-effect">+2.5x luck multiplier</div>
                            <div class="enchant-item-rarity">Rarity: 1/20 (5%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#16a34a;">III</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Luck III</div>
                            <div class="enchant-item-effect">+3.33x luck multiplier</div>
                            <div class="enchant-item-rarity">Rarity: 1/75 (1.33%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#15803d;">IV</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Craziness</div>
                            <div class="enchant-item-effect">+25x luck multiplier</div>
                            <div class="enchant-item-rarity">Rarity: 1/125,000 (0.0008%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Speed -->
            <div class="enchant-type-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('speed')">
                    <h3>‚ö° Speed Enchants</h3><span id="speed-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="speed-content">
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#60a5fa;">I</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Speed I</div>
                            <div class="enchant-item-effect">-0.1s roll time</div>
                            <div class="enchant-item-rarity">Rarity: 1/10 (10%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#3b82f6;">II</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Speed II</div>
                            <div class="enchant-item-effect">-0.25s roll time</div>
                            <div class="enchant-item-rarity">Rarity: 1/25 (4%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#2563eb;">III</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Blitz</div>
                            <div class="enchant-item-effect">-0.5s roll time</div>
                            <div class="enchant-item-rarity">Rarity: 1/100 (1%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#1e40af;">IV</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">KUGELBLITZ</div>
                            <div class="enchant-item-effect">Instant rolls (no animation)</div>
                            <div class="enchant-item-rarity">Rarity: 1/10,000 (0.01%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lighter -->
            <div class="enchant-type-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('lighter')">
                    <h3>‚ú® Lighter Enchants</h3><span id="lighter-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="lighter-content">
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#a78bfa;">I</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Lighter I</div>
                            <div class="enchant-item-effect">+0.5x enchant luck multiplier</div>
                            <div class="enchant-item-rarity">Rarity: 1/100 (1%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#8b5cf6;">II</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Lighter II</div>
                            <div class="enchant-item-effect">+1.25x enchant luck multiplier</div>
                            <div class="enchant-item-rarity">Rarity: 1/2,500 (0.04%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#7c3aed;">III</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Magician</div>
                            <div class="enchant-item-effect">+4x enchant luck multiplier</div>
                            <div class="enchant-item-rarity">Rarity: 1/172,565 (0.00058%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#6d28d9;">IV</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Unnatural</div>
                            <div class="enchant-item-effect">+10x enchant luck multiplier</div>
                            <div class="enchant-item-rarity">Rarity: 1/91,625,715 (0.0000011%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cloner -->
            <div class="enchant-type-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('cloner')">
                    <h3>üìã Cloner Enchants</h3><span id="cloner-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="cloner-content">
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#fb923c;">I</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Cloner I</div>
                            <div class="enchant-item-effect">+1 bulk roll slot</div>
                            <div class="enchant-item-rarity">Rarity: 1/75 (1.33%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#f97316;">II</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Cloner II</div>
                            <div class="enchant-item-effect">+2 bulk roll slots</div>
                            <div class="enchant-item-rarity">Rarity: 1/250 (0.4%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#ea580c;">III</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Duplication</div>
                            <div class="enchant-item-effect">+4 bulk roll slots</div>
                            <div class="enchant-item-rarity">Rarity: 1/50,000 (0.002%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#c2410c;">IV</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Replica</div>
                            <div class="enchant-item-effect">+10 bulk roll slots</div>
                            <div class="enchant-item-rarity">Rarity: 1/7,500,000 (0.000013%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Curse (updated with Wrath and shifted tiers) -->
            <div class="enchant-type-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('curse')">
                    <h3>üíÄ Curse Enchants</h3><span id="curse-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="curse-content">
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#ffffff;color:#000000;">G</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Greed</div>
                            <div class="enchant-item-effect">-2.5x luck, +3 bulk rolls, -0.7s roll time (faster but greedier)</div>
                            <div class="enchant-item-rarity">Rarity: 1/57 (1.75%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:linear-gradient(135deg,#ec4899 0%,#f97316 100%);color:#3b82f6;">‚Üì</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Sloth</div>
                            <div class="enchant-item-effect">+5x luck, +2.5s roll time, +5 bulk rolls</div>
                            <div class="enchant-item-rarity">Rarity: 1/163 (0.61%)</div>
                        </div>
                    </div>
                    <!-- new Wrath -->
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#b91c1c;color:#ffd700;">W</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Wrath</div>
                            <div class="enchant-item-effect">+15x luck (total: +10x from first, +5x from second), -1500 bulk roll (minimum 1), +2.5x enchant luck</div>
                            <div class="enchant-item-rarity">Rarity: 1/652 (0.153%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:linear-gradient(135deg,#374151 0%,#000000 100%);color:#22c55e;">!</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Stress</div>
                            <div class="enchant-item-effect">+7.5x luck, +7 bulk rolls, +12.5s roll time</div>
                            <div class="enchant-item-rarity">Rarity: 1/614 (0.16%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb shake-animation" style="background:#ffffff;color:#000000;font-size:0.6em;">HELP</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Insanity</div>
                            <div class="enchant-item-effect">-1000x luck, +10 bulk rolls, +1.5x enchant luck, +1.5s roll time</div>
                            <div class="enchant-item-rarity">Rarity: 1/1,725 (0.058%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#4c1d95;color:#a78bfa;">H</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Heresy</div>
                            <div class="enchant-item-effect">-10,000,000x luck, +15 bulk rolls, +3s roll time, +15x enchant luck</div>
                            <div class="enchant-item-rarity">Rarity: 1/273,627,171.6 (0.00000037%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="overflow:hidden;padding:0;background:transparent;" id="avariceIndexOrb"></div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Avarice</div>
                            <div class="enchant-item-effect">+50 bulk rolls, -100,000,000x luck, +20s roll time, +1.5x enchant luck</div>
                            <div class="enchant-item-rarity">Rarity: 1/12,725,284,173.51 (0.0000000079%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#000000;color:#ff4444;border:2px solid #444;">N</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">nilihilism</div>
                            <div class="enchant-item-effect">-1e303 luck, +1000 enchant luck, +10 secret luck, -7.5s roll time</div>
                            <div class="enchant-item-rarity">Rarity: 1/582,715,271,825 (1.716e-10%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All-in-One (updated with secretLuck and weird) -->
            <div class="enchant-type-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('allinone')">
                    <h3>üîÆ All-in-One Enchants</h3><span id="allinone-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="allinone-content">
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#FFD700;color:#000;">Œ£</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Synergy</div>
                            <div class="enchant-item-effect">Combines all Tier 1 normal enchants (Luck I, Speed I, Lighter I, Cloner I, Weird I)</div>
                            <div class="enchant-item-rarity">Rarity: 1/50,000 (0.002%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#C0C0C0;color:#000;">C</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Convergence</div>
                            <div class="enchant-item-effect">Combines all Tier 2 normal enchants (Luck II, Speed II, Lighter II, Cloner II, Weird II)</div>
                            <div class="enchant-item-rarity">Rarity: 1/1,000,000 (0.0001%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#CD7F32;color:#000;">Œ©</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Combination</div>
                            <div class="enchant-item-effect">Combines all Tier 3 normal enchants (Luck III, Blitz, Magician, Duplication, Abnormal)</div>
                            <div class="enchant-item-rarity">Rarity: 1/727,180,000 (1.375e-7%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#8A2BE2;">‚àû</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">MULTITUDE</div>
                            <div class="enchant-item-effect">Combines all Tier 4 normal enchants (Craziness, KUGELBLITZ, Unnatural, Replica, Unknown)</div>
                            <div class="enchant-item-rarity">Rarity: 1/18,136,725,800 (5.51e-9%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Joke Enchants (added Brick Wall) -->
            <div class="enchant-type-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('joke')">
                    <h3>üòÇ Joke Enchants</h3><span id="joke-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="joke-content">
                    <div class="joke-toggle-row">
                        <span class="joke-toggle-label">Enable Joke Enchants in rolls:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="jokeToggleSwitch" onchange="toggleJokeEnchants(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span id="jokeToggleStatus" style="font-size:0.85em;color:#aaa;">OFF</span>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:transparent;border:none;box-shadow:none;font-size:1.5em;">üß±</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Brick</div>
                            <div class="enchant-item-effect">+1 Brick (does absolutely nothing!)</div>
                            <div class="enchant-item-rarity">Rarity: 1/222 (0.45%) ‚Äî requires joke enchants ON</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#ffd700;color:#ffd700;">„ÄÄ</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Air</div>
                            <div class="enchant-item-effect">Does absolutely nothing.</div>
                            <div class="enchant-item-rarity">Rarity: 1/500 (0.2%) ‚Äî requires joke enchants ON</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:linear-gradient(135deg,#9e9e9e 0%,#000000 100%);">üí•</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Bomber</div>
                            <div class="enchant-item-effect">+5000x luck, +99.99s roll time, -100x enchant luck</div>
                            <div class="enchant-item-rarity">Rarity: 1/6,942,069,420 (0.0000000144%) ‚Äî requires joke enchants ON</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:transparent;border:none;font-size:1.5em;">üêé</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">h o r s e</div>
                            <div class="enchant-item-effect">+0.05 luck, +0.05 rollspeed, -0.05 enchant luck, +0.025 secret luck. If both merged orbs have it, result is not locked!</div>
                            <div class="enchant-item-rarity">Rarity: 1/6969.69 (0.0143%) ‚Äî requires joke enchants ON</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="display:flex;flex-wrap:wrap;gap:1px;background:transparent;border:none;font-size:0.5em;line-height:1;">üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±üß±</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Brick Wall</div>
                            <div class="enchant-item-effect">200 bricks in one! (counts as 200 bricks)</div>
                            <div class="enchant-item-rarity">Rarity: 1/222,222,222,222 ‚Äî requires joke enchants ON</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Special Enchants (updated demonic without extra line) -->
            <div class="enchant-type-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('special')">
                    <h3>‚ú® Special Enchants</h3><span id="special-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="special-content">
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#808080; position:relative;">
                            <span style="position:relative; z-index:2; font-size:1.2em; color:black; text-shadow:0 0 2px white;">Œ±</span>
                            <span style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1.2); color:gold; font-size:1.5em; opacity:0.6;">‚ú¶</span>
                        </div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Alpha</div>
                            <div class="enchant-item-effect">+1 luck, +0.5s speed reduction, +0.25 secret luck, +0.125 enchant luck. If both merged orbs have Alpha, result not locked.</div>
                            <div class="enchant-item-rarity">Rarity: 1/75,000 (0.00133%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:linear-gradient(135deg, #ff69b4, #800080);">
                            <span style="color:black; font-size:1.2em; font-weight:bold;">‚Üë</span>
                        </div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">‚ú¶ Blessing</div>
                            <div class="enchant-item-effect">Gains scaling bonuses with total rolls: +0.001 bulk/roll (cap +19), +0.01 luck/roll (cap +750), +0.05s speed reduction/roll (capped at instant), +0.0025 secret luck/roll (cap +15), +0.001 enchant luck/roll (cap +5). Starts with -12.5s speed reduction.</div>
                            <div class="enchant-item-rarity">Rarity: 1/750,000 (0.000133%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:linear-gradient(135deg, #000, #800080); transform:rotate(-45deg);">
                            <span style="transform:rotate(45deg); display:block; color:white; font-size:1.2em; font-weight:bold;">D</span>
                        </div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Demonic</div>
                            <div class="enchant-item-effect">+6.66 luck, +33.33 secret luck.</div>
                            <div class="enchant-item-rarity">Rarity: 1/666,666.66 (0.00015%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet); animation: rainbowMove 2s linear infinite;">
                            <span style="color:white; font-weight:bold;">M</span>
                        </div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">MYTHICAL</div>
                            <div class="enchant-item-effect">Each roll: luck = random()**-1, secret luck = 1+random()**-1.5, bulk = random(1,10).</div>
                            <div class="enchant-item-rarity">Rarity: 1/10,000,000 (0.00001%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weird Enchants -->
            <div class="enchant-type-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('weird')">
                    <h3>üåÄ Weird Enchants</h3><span id="weird-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="weird-content">
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#6a0dad;">I</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Weird I</div>
                            <div class="enchant-item-effect">+1.5x secret luck</div>
                            <div class="enchant-item-rarity">Rarity: 1/75 (1.33%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#4b0082;">II</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Weird II</div>
                            <div class="enchant-item-effect">+3x secret luck</div>
                            <div class="enchant-item-rarity">Rarity: 1/520 (0.192%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#2e0854;">III</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Abnormal</div>
                            <div class="enchant-item-effect">+10x secret luck</div>
                            <div class="enchant-item-rarity">Rarity: 1/62,570 (0.0016%)</div>
                        </div>
                    </div>
                    <div class="enchant-item">
                        <div class="enchant-orb" style="background:#1a001a;">IV</div>
                        <div class="enchant-item-info">
                            <div class="enchant-item-name">Unknown</div>
                            <div class="enchant-item-effect">+50x secret luck</div>
                            <div class="enchant-item-rarity">Rarity: 1/71,525,015 (0.0000014%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secret Numbers (with -666) -->
            <div class="enchant-type-section secret-section">
                <div class="enchant-type-header" onclick="toggleEnchantType('secrets')">
                    <h3>üîí Secret Numbers</h3><span id="secrets-toggle">‚ñº</span>
                </div>
                <div class="enchant-type-content" id="secrets-content">
                    <p style="font-size:0.85em;opacity:0.7;margin-bottom:10px;">
                        Secret numbers can replace any slot in the roll track. They always replace that one slot when triggered. If the raw RNG floor for that slot was ‚â• 1000, the secret number slot can also carry an enchant.
                    </p>
                    <div class="secret-item">
                        <div class="secret-value-badge" style="background:url('public/images/nerd.png'); background-size:cover; border:none; border-radius:4px;"></div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">hl3</div>
                            <div class="secret-item-rarity">Chance per slot: 1/3,333,333 (0.00003%)</div>
                            <div class="secret-item-note">Special logRNG: -0.03</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge" style="background:url('public/images/brogo.png'); background-size:cover; border:none; border-radius:4px;"></div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">brogo</div>
                            <div class="secret-item-rarity">Chance per slot: 1/650,000 (0.00015%)</div>
                            <div class="secret-item-note">Special logRNG: -0.02</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-0.69</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -0.69</div>
                            <div class="secret-item-rarity">Chance per slot: 1/690 (0.145%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-2.8</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -2.8</div>
                            <div class="secret-item-rarity">Chance per slot: 1/1,000 (0.1%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-3.5</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -3.5</div>
                            <div class="secret-item-rarity">Chance per slot: 1/3,500 (0.0286%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-8</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -8</div>
                            <div class="secret-item-rarity">Chance per slot: 1/8,888 (0.01125%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-1.75</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -1.75</div>
                            <div class="secret-item-rarity">Chance per slot: 1/9,999 (0.01%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-0.25</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -0.25</div>
                            <div class="secret-item-rarity">Chance per slot: 1/12,500 (0.008%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-1000</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -1000</div>
                            <div class="secret-item-rarity">Chance per slot: 1/20,000 (0.005%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-31.4</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -31.4</div>
                            <div class="secret-item-rarity">Chance per slot: 1/31,415 (0.00318%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-1.23</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -1.23</div>
                            <div class="secret-item-rarity">Chance per slot: 1/50,000 (0.002%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-7</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -7</div>
                            <div class="secret-item-rarity">Chance per slot: 1/77,777 (0.001286%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-101</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -101</div>
                            <div class="secret-item-rarity">Chance per slot: 1/101,000 (0.00099%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000</div>
                        </div>
                    </div>
                    <div class="secret-item" style="border-color:rgba(255,0,0,0.3);background:rgba(50,0,0,0.2);">
                        <div class="secret-value-badge" style="border-color:rgba(255,0,0,0.5);min-width:80px;"><span class="epilepsy-text" style="font-size:0.6em;">!! EPILEPSY !!</span></div>
                        <div class="secret-item-info">
                            <div class="secret-item-value"><span class="epilepsy-text">!! EPILEPSY !!</span></div>
                            <div class="secret-item-rarity">Chance per slot: 1/1,234,567 (0.000081%)</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000.</div>
                        </div>
                    </div>
                    <div class="secret-item">
                        <div class="secret-value-badge">-666</div>
                        <div class="secret-item-info">
                            <div class="secret-item-value">logRNG: -666</div>
                            <div class="secret-item-rarity">Special needs.</div>
                            <div class="secret-item-note">Can have enchant if raw floor ‚â• 1000.</div>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- /enchant-index -->
    </div>
</div><!-- /container -->

<div class="modal" id="deleteModal">
    <div class="modal-content">
        <h2>Delete?</h2>
        <p>Are you sure you want to delete <span id="deleteRankValue"></span>?</p>
        <div class="modal-buttons">
            <button class="confirm-btn" onclick="confirmDelete()">Delete</button>
            <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// SOUND EFFECTS
// ============================================================
const SFX = {
    coinLow: new Audio('public/sfx/pickupCoin.wav'),
    coinHigh: new Audio('public/sfx/coin_pickup.wav'),
    explosion: new Audio('public/sfx/explosion.wav'),
    powerup: new Audio('public/sfx/powerup.wav'),
    synth: new Audio('public/sfx/synth.wav'),
    synth1: new Audio('public/sfx/synth1.wav'),
    cowm: new Audio('public/sfx/cowm.wav'),
    t100: new Audio('public/sfx/100t.wav'),
    lobotomy: new Audio('public/sfx/lobotomy.mp3')
};

function playRankSFX(slot) {
    if (slot.isSecret) {
        if (slot.rawFloor > 10000000) {
            SFX.lobotomy.currentTime = 0;
            SFX.lobotomy.play().catch(() => {});
        } else if (slot.rawFloor > 1000000) {
            SFX.t100.currentTime = 0;
            SFX.t100.play().catch(() => {});
        } else if (slot.rawFloor < 1000000 && slot.rawFloor >= 50000) {
            // No specific sound for this range in request? 
            // "cowm for secrets under floor = 1,000,000" covers this too.
            SFX.cowm.currentTime = 0;
            SFX.cowm.play().catch(() => {});
        } else if (slot.rawFloor < 50000) {
            SFX.synth1.currentTime = 0;
            SFX.synth1.play().catch(() => {});
        } else {
            // Fallback for secrets
            SFX.cowm.currentTime = 0;
            SFX.cowm.play().catch(() => {});
        }
    } else {
        const val = slot.value;
        if (val >= 6) {
            SFX.explosion.currentTime = 0;
            SFX.explosion.play().catch(() => {});
        } else if (val >= 5) {
            SFX.synth.currentTime = 0;
            SFX.synth.play().catch(() => {});
        } else if (val >= 4) {
            SFX.powerup.currentTime = 0;
            SFX.powerup.play().catch(() => {});
        } else if (val >= 3) {
            SFX.coinHigh.currentTime = 0;
            SFX.coinHigh.play().catch(() => {});
        } else {
            SFX.coinLow.currentTime = 0;
            SFX.coinLow.play().catch(() => {});
        }
    }
}

// ============================================================
// CONSTANTS
// ============================================================
const MAX_INVENTORY = 60;
const MAX_ENCHANTS = 30;
const ITEMS_PER_PAGE = 10;
const TOTAL_PAGES = 6;
const ENCHANTS_PER_PAGE = 10;
const TOTAL_ENCHANT_PAGES = 3;
const BASE_ROLL_DURATION = 1750;
const MIN_ROLL_DURATION = 100;

// ============================================================
// GAME STATE
// ============================================================
let gameState = {
    inventory: [],
    enchantOrbs: [],
    equippedOrb: null,
    pendingRolls: [],
    jokeEnchantsEnabled: false,
    brickCount: 0,
    luckButtonClicks: 0,
    secretLuckButtonClicks: 0,
    mergeSelection: [],
    mergeModeActive: false,
    bulkDeleteMode: false,
    bulkDeleteEnchantMode: false,
    selectedInventoryIndices: [],
    selectedEnchantIndices: [],
    stats: {
        totalRolls: 0,
        acceptedRanks: 0,
        highestRank: null,
        totalValue: 0
    },
    isRolling: false,
    deleteIndex: null,
    deleteEnchantIndex: null,
    currentPage: 1,
    currentEnchantPage: 1,
    mythicalLuck: 1,
    mythicalSecretLuck: 1,
    mythicalBulk: 1
};

// ============================================================
// ENCHANT DEFINITIONS (updated with Wrath and shifted curse tiers)
// ============================================================
const ENCHANTS = {
    // --- Luck ---
    luck1:       { name: 'Luck I',     type: 'luck',    tier: 1, rarity: 1/5,           effect: 0.5,      color: '#4ade80' },
    luck2:       { name: 'Luck II',    type: 'luck',    tier: 2, rarity: 1/20,          effect: 2.5,      color: '#22c55e' },
    luck3:       { name: 'Luck III',   type: 'luck',    tier: 3, rarity: 1/75,          effect: 3.33,     color: '#16a34a' },
    craziness:   { name: 'Craziness',  type: 'luck',    tier: 4, rarity: 1/125000,      effect: 25,       color: '#15803d' },

    // --- Speed ---
    speed1:      { name: 'Speed I',    type: 'speed',   tier: 1, rarity: 1/10,          effect: 0.1,      color: '#60a5fa' },
    speed2:      { name: 'Speed II',   type: 'speed',   tier: 2, rarity: 1/25,          effect: 0.25,     color: '#3b82f6' },
    blitz:       { name: 'Blitz',      type: 'speed',   tier: 3, rarity: 1/100,         effect: 0.5,      color: '#2563eb' },
    kugelblitz:  { name: 'KUGELBLITZ', type: 'speed',   tier: 4, rarity: 1/10000,       effect: 'instant',color: '#1e40af' },

    // --- Lighter ---
    lighter1:    { name: 'Lighter I',  type: 'lighter', tier: 1, rarity: 1/100,         effect: 0.5,      color: '#a78bfa' },
    lighter2:    { name: 'Lighter II', type: 'lighter', tier: 2, rarity: 1/2500,        effect: 1.25,     color: '#8b5cf6' },
    magician:    { name: 'Magician',   type: 'lighter', tier: 3, rarity: 1/172565,      effect: 4,        color: '#7c3aed' },
    unnatural:   { name: 'Unnatural',  type: 'lighter', tier: 4, rarity: 1/91625715,    effect: 10,       color: '#6d28d9' },

    // --- Cloner ---
    cloner1:     { name: 'Cloner I',   type: 'cloner',  tier: 1, rarity: 1/75,          effect: 1,        color: '#fb923c' },
    cloner2:     { name: 'Cloner II',  type: 'cloner',  tier: 2, rarity: 1/250,         effect: 2,        color: '#f97316' },
    duplication: { name: 'Duplication',type: 'cloner',  tier: 3, rarity: 1/50000,       effect: 4,        color: '#ea580c' },
    replica:     { name: 'Replica',    type: 'cloner',  tier: 4, rarity: 1/7500000,     effect: 10,       color: '#c2410c' },

    // --- Curses (updated with Wrath and shifted tiers) ---
    greed: {
        name: 'Greed', type: 'curse', tier: 1, rarity: 1/57,
        effects: { luck: -2.5, cloner: 3, speed: 0.7 },
        display: 'G', color: '#ffffff', textColor: '#000000'
    },
    sloth: {
        name: 'Sloth', type: 'curse', tier: 2, rarity: 1/163,
        effects: { luck: 5, speed: -2.5, cloner: 5 },
        display: '‚Üì', color: 'linear-gradient(135deg,#ec4899 0%,#f97316 100%)', textColor: '#3b82f6'
    },
    wrath: {
        name: 'Wrath', type: 'curse', tier: 3, rarity: 1/652,
        effects: { luck: 15, cloner: -1500, lighter: 2.5 }, // +10x luck and +5x luck combined, bulk -1500, enchant luck +2.5
        display: 'W', color: '#b91c1c', textColor: '#ffd700'
    },
    stress: {
        name: 'Stress', type: 'curse', tier: 4, rarity: 1/614,
        effects: { luck: 7.5, cloner: 7, speed: -12.5 },
        display: '!', color: 'linear-gradient(135deg,#374151 0%,#000000 100%)', textColor: '#22c55e'
    },
    insanity: {
        name: 'Insanity', type: 'curse', tier: 5, rarity: 1/1725,
        effects: { luck: -1000, cloner: 10, lighter: 1.5, speed: -1.5 },
        display: 'HELP', color: '#ffffff', textColor: '#000000', shake: true
    },
    heresy: {
        name: 'Heresy', type: 'curse', tier: 6, rarity: 1/273627171.6,
        effects: { luck: -10000000, cloner: 15, speed: -3, lighter: 15 },
        display: 'H', color: '#4c1d95', textColor: '#a78bfa'
    },
    avarice: {
        name: 'Avarice', type: 'curse', tier: 7, rarity: 1/12725284173.51,
        effects: { luck: -100000000, cloner: 50, speed: -20, lighter: 1.5 },
        display: 'A', color: 'avarice', textColor: '#fff', isAvarice: true
    },
    nihilism: {
        name: 'nilihilism', type: 'curse', tier: 8, rarity: 1/582715271825,
        effects: { luck: -1e303, lighter: 1000, speed: -7.5, secretLuck: 10 },
        display: 'N', color: '#000000', textColor: '#ff4444'
    },

    // --- All-in-One ---
    synergy: {
        name: 'Synergy', type: 'allinone', tier: 1, rarity: 1/50000,
        effects: { luck: 0.5, speed: 0.1, lighter: 0.5, cloner: 1, secretLuck: 1.5 },
        display: 'Œ£', color: '#FFD700', textColor: '#000000'
    },
    convergence: {
        name: 'Convergence', type: 'allinone', tier: 2, rarity: 1/1000000,
        effects: { luck: 2.5, speed: 0.25, lighter: 1.25, cloner: 2, secretLuck: 3 },
        display: 'C', color: '#C0C0C0', textColor: '#000000'
    },
    combination: {
        name: 'Combination', type: 'allinone', tier: 3, rarity: 1/727180000,
        effects: { luck: 3.33, speed: 0.5, lighter: 4, cloner: 4, secretLuck: 10 },
        display: 'Œ©', color: '#CD7F32', textColor: '#000000'
    },
    multitude: {
        name: 'MULTITUDE', type: 'allinone', tier: 4, rarity: 1/18136725800,
        effects: { luck: 25, speed: 'instant', lighter: 10, cloner: 10, secretLuck: 50 },
        display: '‚àû', color: '#8A2BE2', textColor: '#ffffff'
    },

    // --- Joke Enchants ---
    air: {
        name: 'Air', type: 'joke', tier: 1, rarity: 1/500,
        effects: {},
        display: '', color: '#ffd700', textColor: '#ffd700',
        jokeOnly: true
    },
    bomber: {
        name: 'Bomber', type: 'joke', tier: 2, rarity: 1/6942069420,
        effects: { luck: 5000, speed: -99.99, lighter: -100 },
        display: 'üí•', color: 'linear-gradient(135deg,#9e9e9e 0%,#000000 100%)', textColor: '#ffffff',
        jokeOnly: true
    },
    brick: {
        name: 'Brick', type: 'joke', tier: 3, rarity: 1/222,
        effects: { brick: 1, luck: 5, speed: 1, lighter: 1.5, secretLuck: 5 },
        display: 'üß±', color: 'transparent', textColor: '#ffffff', noBorder: true,
        jokeOnly: true
    },
    horse: {
        name: 'h o r s e', type: 'joke', tier: 4, rarity: 1/6969.69,
        effects: { luck: 0.05, speed: 0.05, lighter: -0.05, secretLuck: 0.025 },
        display: 'üêé', color: 'transparent', textColor: '#ffffff', noBorder: true,
        jokeOnly: true
    },
    brickwall: {
        name: 'Brick Wall', type: 'joke', tier: 5, rarity: 1/222222222222,
        effects: { brick: 200 },
        display: 'üß±', color: 'transparent', textColor: '#ffffff', noBorder: true, brickWall: true,
        jokeOnly: true
    },

    // --- Special Enchants ---
    alpha: {
        name: 'Alpha', type: 'special', tier: 1, rarity: 1/75000,
        effects: { luck: 1, speed: 0.5, secretLuck: 0.25, lighter: 0.125 },
        color: '#808080', specialDesign: 'alpha'
    },
    blessing: {
        name: '‚ú¶ Blessing', type: 'special', tier: 2, rarity: 1/750000,
        effects: { }, // dynamic
        color: 'linear-gradient(135deg, #ff69b4, #800080)', specialDesign: 'blessing'
    },
    demonic: {
        name: 'Demonic', type: 'special', tier: 3, rarity: 1/666666.66,
        effects: { luck: 6.66, secretLuck: 33.33 },
        color: 'linear-gradient(135deg, #000, #800080)', specialDesign: 'demonic'
    },
    mythical: {
        name: 'MYTHICAL', type: 'special', tier: 4, rarity: 1/10000000,
        effects: { }, // dynamic per roll
        color: 'rainbow', specialDesign: 'mythical'
    },

    // --- Weird Enchants ---
    weird1: {
        name: 'Weird I', type: 'weird', tier: 1, rarity: 1/75,
        effect: 1.5, color: '#6a0dad'
    },
    weird2: {
        name: 'Weird II', type: 'weird', tier: 2, rarity: 1/520,
        effect: 3, color: '#4b0082'
    },
    abnormal: {
        name: 'Abnormal', type: 'weird', tier: 3, rarity: 1/62570,
        effect: 10, color: '#2e0854'
    },
    unknown: {
        name: 'Unknown', type: 'weird', tier: 4, rarity: 1/71525015,
        effect: 50, color: '#1a001a'
    }
};

// ============================================================
// SECRET NUMBERS (unchanged)
// ============================================================
const SECRET_NUMBERS_RAW = [
    { logValue: -0.03,  rarity: 1/3333333, display: 'hl3', isNerd: true, isHl3: true },
    { logValue: -0.02,  rarity: 1/650000, display: 'brogo', isBrogo: true },
    { logValue: -0.69,  rarity: 1/690,     display: '-0.69' },
    { logValue: -2.8,   rarity: 1/1000,    display: '-2.8'  },
    { logValue: -3.5,   rarity: 1/3500,    display: '-3.5'  },
    { logValue: -8,     rarity: 1/8888,    display: '-8'    },
    { logValue: -1.75,  rarity: 1/9999,    display: '-1.75' },
    { logValue: -0.25,  rarity: 1/12500,   display: '-0.25' },
    { logValue: -1000,  rarity: 1/20000,   display: '-1000' },
    { logValue: -31.4,  rarity: 1/31415,   display: '-31.4' },
    { logValue: -1.23,  rarity: 1/50000,   display: '-1.23' },
    { logValue: -7,     rarity: 1/77777,   display: '-7'    },
    { logValue: -101,   rarity: 1/101000,  display: '-101'  },
    { logValue: -9999,  rarity: 1/1234567, display: 'EPILEPSY', isEpilepsy: true },
    { logValue: -666,   rarity: 0,          display: '-666', isDemonicSecret: true }
];
const SECRET_NUMBERS = [...SECRET_NUMBERS_RAW].sort((a, b) => a.rarity - b.rarity);

// ============================================================
// AVARICE SVG (unchanged)
// ============================================================
function getAvariceSVG(size) {
    const cx = size / 2;
    const cy = size / 2;
    const vRadius = size * 0.31;
    const vFontSize = Math.max(4, size * 0.185);
    const aFontSize = Math.max(5, size * 0.24);
    const uid = 'av_' + Math.random().toString(36).substr(2, 9);

    let vTexts = '';
    for (let i = 0; i < 6; i++) {
        const angle = i * 60;
        vTexts += `<text x="${cx}" y="${cy - vRadius}"
            text-anchor="middle" dominant-baseline="auto"
            font-size="${vFontSize}" font-weight="bold"
            fill="url(#${uid}_vg)"
            transform="rotate(${angle} ${cx} ${cy})">V</text>`;
    }

    return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
        <defs>
            <linearGradient id="${uid}_bg" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#7c3aed"/>
                <stop offset="50%" stop-color="#eab308"/>
                <stop offset="100%" stop-color="#9ca3af"/>
            </linearGradient>
            <linearGradient id="${uid}_vg" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#000000"/>
                <stop offset="100%" stop-color="#ffffff"/>
            </linearGradient>
        </defs>
        <circle cx="${cx}" cy="${cy}" r="${size/2}" fill="url(#${uid}_bg)"/>
        ${vTexts}
        <text x="${cx}" y="${cy + aFontSize * 0.38}"
            text-anchor="middle" dominant-baseline="middle"
            font-size="${aFontSize}" font-weight="bold"
            fill="url(#${uid}_vg)">A</text>
    </svg>`;
}

// ============================================================
// ENCHANT STAT HELPERS (updated with Wrath and bulk minimum)
// ============================================================

function getEquippedBrickCount() {
    if (!gameState.equippedOrb || !gameState.equippedOrb.enchants.brick) return 0;
    let count = 0;
    Object.values(gameState.equippedOrb.enchants).forEach(e => {
        if (e.name === 'Brick') count += e.count || 1;
        if (e.name === 'Brick Wall') count += 200;
    });
    return count;
}

function getBlessingBonuses() {
    let bulk = 0, luck = 0, speed = 0, secretLuck = 0, enchantLuck = 0;
    if (!gameState.equippedOrb) return { bulk, luck, speed, secretLuck, enchantLuck };
    const hasBlessing = Object.values(gameState.equippedOrb.enchants).some(e => e.name === '‚ú¶ Blessing');
    if (!hasBlessing) return { bulk, luck, speed, secretLuck, enchantLuck };
    const rolls = gameState.stats.totalRolls;
    bulk = Math.min(19, Math.floor(rolls * 0.001));
    luck = Math.min(750, rolls * 0.01);
    speed = Math.min(12.5, rolls * 0.05);
    secretLuck = Math.min(15, rolls * 0.0025);
    enchantLuck = Math.min(5, rolls * 0.001);
    return { bulk, luck, speed, secretLuck, enchantLuck };
}

function getLuckMultiplier() {
    let luck = 1;
    const bricks = getEquippedBrickCount();
    const blessing = getBlessingBonuses();
    if (!gameState.equippedOrb) return Math.max(1, luck + bricks * 5 + blessing.luck);
    Object.values(gameState.equippedOrb.enchants).forEach(e => {
        if (e.type === 'luck') {
            luck += e.effect;
        } else if (e.type === 'allinone' && e.effects && e.effects.luck != null) {
            luck += e.effects.luck;
        } else if (e.type === 'curse' && e.effects && e.effects.luck != null) {
            luck += e.effects.luck;
        } else if (e.type === 'joke' && e.effects && e.effects.luck != null && e.name !== 'Brick') {
            luck += e.effects.luck;
        } else if (e.type === 'special' && e.name === 'Alpha') {
            luck += 1;
        } else if (e.type === 'special' && e.name === 'Demonic') {
            luck += 6.66;
        } else if (e.type === 'special' && e.name === 'MYTHICAL') {
            luck += gameState.mythicalLuck;
        }
    });
    luck += bricks * 5 + blessing.luck;
    return Math.max(1, luck);
}

function getEnchantLuckMultiplier() {
    let mult = 1;
    const bricks = getEquippedBrickCount();
    const blessing = getBlessingBonuses();
    if (!gameState.equippedOrb) return mult + bricks * 1.5 + blessing.enchantLuck;
    Object.values(gameState.equippedOrb.enchants).forEach(e => {
        if (e.type === 'lighter') {
            mult += e.effect;
        } else if (e.type === 'allinone' && e.effects && e.effects.lighter != null) {
            mult += e.effects.lighter;
        } else if (e.type === 'curse' && e.effects && e.effects.lighter != null) {
            mult += e.effects.lighter;
        } else if (e.type === 'joke' && e.effects && e.effects.lighter != null && e.name !== 'Brick') {
            mult += e.effects.lighter;
        } else if (e.type === 'special' && e.name === 'Alpha') {
            mult += 0.125;
        }
    });
    mult += bricks * 1.5 + blessing.enchantLuck;
    return mult;
}

function getBulkRolls() {
    let total = 1;
    const blessing = getBlessingBonuses();
    if (!gameState.equippedOrb) return Math.max(1, total + blessing.bulk);
    Object.values(gameState.equippedOrb.enchants).forEach(e => {
        if (e.type === 'cloner') {
            total += e.effect;
        } else if (e.type === 'allinone' && e.effects && e.effects.cloner != null) {
            total += e.effects.cloner;
        } else if (e.type === 'curse' && e.effects && e.effects.cloner != null) {
            total += e.effects.cloner;
        } else if (e.type === 'joke' && e.effects && e.effects.cloner != null) {
            total += e.effects.cloner;
        } else if (e.type === 'special' && e.name === 'MYTHICAL') {
            total += gameState.mythicalBulk;
        }
    });
    total += blessing.bulk;
    return Math.max(1, Math.round(total)); // ensure at least 1
}

function getSpeedConfig() {
    let savedSeconds = 0;
    let isInstant = false;
    const bricks = getEquippedBrickCount();
    const blessing = getBlessingBonuses();
    const hasBlessing = gameState.equippedOrb && 
                        Object.values(gameState.equippedOrb.enchants).some(e => e.name === '‚ú¶ Blessing');

    if (!gameState.equippedOrb) {
        savedSeconds += bricks * 1;
        // No Blessing ‚Üí no penalty
        savedSeconds += blessing.speed;
        return { savedSeconds, isInstant };
    }

    Object.values(gameState.equippedOrb.enchants).forEach(e => {
        if (e.type === 'speed') {
            if (e.effect === 'instant') isInstant = true;
            else savedSeconds += e.effect;
        } else if (e.type === 'allinone' && e.effects && e.effects.speed != null) {
            if (e.effects.speed === 'instant') isInstant = true;
            else savedSeconds += e.effects.speed;
        } else if (e.type === 'curse' && e.effects && e.effects.speed != null) {
            savedSeconds += e.effects.speed;
        } else if (e.type === 'joke' && e.effects && e.effects.speed != null && e.name !== 'Brick') {
            savedSeconds += e.effects.speed;
        } else if (e.type === 'special' && e.name === 'Alpha') {
            savedSeconds += 0.5;
        }
    });

    savedSeconds += bricks * 1;

    if (hasBlessing) {
        savedSeconds -= 12.5;           // Blessing's starting penalty
    }
    savedSeconds += blessing.speed;      // positive scaling from rolls

    return { savedSeconds, isInstant };
}

function getSecretLuckMultiplier() {
    let mult = 1;
    const blessing = getBlessingBonuses();
    if (!gameState.equippedOrb) return mult + blessing.secretLuck;
    Object.values(gameState.equippedOrb.enchants).forEach(e => {
        if (e.effects && e.effects.secretLuck != null) {
            mult += e.effects.secretLuck;
        } else if (e.type === 'weird') {
            mult += e.effect;
        } else if (e.type === 'special' && e.name === 'Alpha') {
            mult += 0.25;
        } else if (e.type === 'special' && e.name === 'Demonic') {
            mult += 33.33;
        } else if (e.type === 'special' && e.name === 'MYTHICAL') {
            mult += gameState.mythicalSecretLuck;
        } else if (e.type === 'allinone' && e.effects && e.effects.secretLuck != null) {
            mult += e.effects.secretLuck;
        }
    });
    mult += blessing.secretLuck;
    return Math.max(0.1, mult);
}

function getSecretLuckButtonBoost() {
    if (gameState.secretLuckButtonClicks <= 0) return 1;
    return 1 + Math.pow(Math.log10(gameState.secretLuckButtonClicks), 0.8);
}

function getRollDuration() {
    const { savedSeconds, isInstant } = getSpeedConfig();
    if (isInstant) return 0;
    return Math.max(MIN_ROLL_DURATION, BASE_ROLL_DURATION - Math.round(savedSeconds * 1000));
}

// ============================================================
// LUCK BUTTONS (unchanged)
// ============================================================
function getButtonLuckBoost() {
    if (gameState.luckButtonClicks <= 0) return 1;
    return 1 + Math.max(1, Math.pow(Math.log(gameState.luckButtonClicks) / Math.log(5), 0.75));
}

function clickLuckButton() {
    gameState.luckButtonClicks++;
    const boost = getButtonLuckBoost();
    document.getElementById('luckBoostDisplay').textContent =
        `Luck boost: √ó${boost.toFixed(3)} (click ${gameState.luckButtonClicks})`;
}

function clickSecretLuckButton() {
    gameState.secretLuckButtonClicks++;
    const boost = getSecretLuckButtonBoost();
    document.getElementById('secretLuckBoostDisplay').textContent =
        `Secret luck boost: √ó${boost.toFixed(3)} (click ${gameState.secretLuckButtonClicks})`;
}

// ============================================================
// SLOT GENERATION (unchanged)
// ============================================================

function generateSlot(luckMult, enchantLuckMult, isAcceptableSlot) {
    const random = Math.random();
    let rawFloor = Math.floor(Math.pow(random, -1.5));
    rawFloor = Math.floor(rawFloor * luckMult);
    if (rawFloor < 1) rawFloor = 1;
    let logValue = Number(Math.log10(rawFloor).toFixed(2));

    if (isAcceptableSlot && gameState.equippedOrb && Object.values(gameState.equippedOrb.enchants).some(e => e.name === 'Demonic')) {
        if (Math.random() < 1/66666.66) {
            const enchant = (rawFloor >= 1000) ? rollEnchant(enchantLuckMult) : null;
            return {
                value: -666,
                rawFloor,
                isSecret: true,
                secretDisplay: '-666',
                enchant
            };
        }
    }

    if (isAcceptableSlot) {
        const secret = checkSecretNumber();
        if (secret) {
            const enchant = (rawFloor >= 1000) ? rollEnchant(enchantLuckMult) : null;
            return {
                value: secret.logValue,
                rawFloor,
                isSecret: true,
                isBrogo: !!secret.isBrogo,
                isNerd: !!secret.isNerd,
                isHl3: !!secret.isHl3,
                isEpilepsy: !!secret.isEpilepsy,
                secretDisplay: secret.display,
                enchant
            };
        }
    }

    let imaginary = false, negative = false;
    if (Math.random() < 1/85) imaginary = true;
    if (Math.random() < 1/25) negative = true;

    let displayValue = logValue;
    if (negative) displayValue = -displayValue;
    if (imaginary) displayValue = displayValue + 'i';

    const enchant = (rawFloor >= 1000) ? rollEnchant(enchantLuckMult) : null;

    return {
        value: logValue,
        rawFloor,
        isSecret: false,
        imaginary,
        negative,
        displayValue,
        enchant
    };
}

function checkSecretNumber() {
    const roll = Math.random();
    const baseSecretLuck = getSecretLuckMultiplier();
    const buttonBoost = getSecretLuckButtonBoost();
    const totalSecretLuck = baseSecretLuck * buttonBoost;
    for (const s of SECRET_NUMBERS) {
        if (s.rarity > 0 && roll < s.rarity * totalSecretLuck) return s;
    }
    return null;
}

function rollEnchant(enchantLuckMult) {
    if (enchantLuckMult <= 0) return null;
    const roll = Math.random();
    const eligible = Object.entries(ENCHANTS)
        .filter(([key, e]) => {
            if (e.jokeOnly && !gameState.jokeEnchantsEnabled) return false;
            return true;
        })
        .map(([key, e]) => ({ key, ...e }))
        .sort((a, b) => a.rarity - b.rarity);

    for (const e of eligible) {
        const threshold = e.rarity * enchantLuckMult;
        if (roll < threshold) {
            return { ...e };
        }
    }
    return null;
}

// ============================================================
// RARITY CLASS (unchanged)
// ============================================================
function getRarityClass(v) {
    if (v < 0)  return 'rarity-neg';
    if (v >= 8) return 'rarity-8';
    if (v >= 7) return 'rarity-7';
    if (v >= 6) return 'rarity-6';
    if (v >= 5) return 'rarity-5';
    if (v >= 4) return 'rarity-4';
    if (v >= 3) return 'rarity-3';
    if (v >= 2) return 'rarity-2';
    if (v >= 1) return 'rarity-1';
    return 'rarity-0';
}

// ============================================================
// ENCHANT DISPLAY HELPERS (unchanged)
// ============================================================

function getEnchantDisplay(enchant) {
    if (enchant.display !== undefined && enchant.display !== null) return enchant.display;
    const numerals = ['I','II','III','IV','V','VI'];
    return numerals[(enchant.tier || 1) - 1] || String(enchant.tier);
}

function enchantOrbHTML(enchant, size, extraClass = '', titleAttr = '') {
    if (!enchant) return '';

    if (enchant.isAvarice) {
        const shakeAttr = enchant.shake ? ' class="shake-animation"' : '';
        return `<div${shakeAttr} style="width:${size}px;height:${size}px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;" title="${titleAttr || enchant.name}">
            ${getAvariceSVG(size - 4)}
        </div>`;
    }

    if (enchant.specialDesign === 'alpha') {
        return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:#808080;display:flex;align-items:center;justify-content:center;position:relative;" title="${titleAttr || enchant.name}">
            <span style="position:relative; z-index:2; color:black; font-size:${size*0.6}px; text-shadow:0 0 2px white;">Œ±</span>
            <span style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1.2); color:gold; font-size:${size*0.7}px; opacity:0.6;">‚ú¶</span>
        </div>`;
    }
    if (enchant.specialDesign === 'blessing') {
        return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:linear-gradient(135deg, #ff69b4, #800080);display:flex;align-items:center;justify-content:center;" title="${titleAttr || enchant.name}">
            <span style="color:black; font-size:${size*0.6}px; font-weight:bold;">‚Üë</span>
        </div>`;
    }
    if (enchant.specialDesign === 'demonic') {
        return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:linear-gradient(135deg, #000, #800080);transform:rotate(-45deg);display:flex;align-items:center;justify-content:center;" title="${titleAttr || enchant.name}">
            <span style="transform:rotate(45deg); display:block; color:white; font-size:${size*0.6}px; font-weight:bold;">D</span>
        </div>`;
    }
    if (enchant.specialDesign === 'mythical') {
        return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet); animation: rainbowMove 2s linear infinite; display:flex; align-items:center; justify-content:center;" title="${titleAttr || enchant.name}">
            <span style="color:white; font-size:${size*0.6}px; font-weight:bold;">M</span>
        </div>`;
    }

    if (enchant.name === 'Brick Wall') {
        return `<div style="display:flex; flex-wrap:wrap; gap:1px; width:${size}px; height:${size}px; background:transparent; align-items:center; justify-content:center;" title="${titleAttr || enchant.name}">
            ${Array(20).fill('üß±').join('')}
        </div>`;
    }

    if (enchant.name === 'Brick' && enchant.count && enchant.count > 1) {
        return `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;" title="${titleAttr || enchant.name} √ó${enchant.count}">
            <span style="font-size:${size * 0.55}px;line-height:1;">üß±</span>
            <span style="font-size:${Math.max(7, size * 0.28)}px;color:#ffd700;font-weight:bold;">√ó${enchant.count}</span>
        </div>`;
    }

    const displayText = getEnchantDisplay(enchant);
    const textColor = enchant.textColor || 'white';
    const fontSize = (displayText === 'HELP') ? `${size * 0.25}px`
                   : (displayText && displayText.length > 2) ? `${size * 0.28}px`
                   : `${size * 0.36}px`;
    const shakeClass = enchant.shake ? ' shake-animation' : '';
    const borderStyle = enchant.noBorder ? 'none' : '2px solid rgba(255,255,255,0.3)';

    let bgStyle;
    if (!enchant.color || enchant.color === 'transparent') {
        bgStyle = 'background: transparent;';
    } else if (enchant.color.includes('gradient') || enchant.color.includes('linear')) {
        bgStyle = `background: ${enchant.color};`;
    } else {
        bgStyle = `background-color: ${enchant.color};`;
    }

    return `<div class="${extraClass}${shakeClass}" 
        style="${bgStyle} color:${textColor}; font-size:${fontSize}; font-weight:bold;
               width:${size}px; height:${size}px; border-radius:50%;
               display:flex; align-items:center; justify-content:center;
               border:${borderStyle}; box-shadow: 0 0 10px rgba(0,0,0,0.5); overflow:hidden;"
        title="${titleAttr || enchant.name}">
        ${displayText}
    </div>`;
}

function orbEnchantsHTML(orb) {
    const enchantTypes = Object.keys(orb.enchants);
    if (enchantTypes.length === 0) return '<span style="opacity:0.5;font-size:0.8em;">Empty orb</span>';
    let html = '<div class="orb-enchants-display">';
    enchantTypes.forEach(t => {
        const e = orb.enchants[t];
        html += enchantOrbHTML(e, 35, '', e.name);
    });
    html += '</div>';
    return html;
}

// ============================================================
// ORB MANAGEMENT (unchanged)
// ============================================================

function createEnchantOrb() {
    return { id: Date.now() + Math.random(), enchants: {}, timestamp: Date.now() };
}

function addEnchantToOrb(orb, enchant) {
    const type = enchant.type;

    if (enchant.name === 'Brick') {
        if (!orb.enchants.brick) {
            orb.enchants.brick = { ...enchant, count: 1 };
        } else {
            orb.enchants.brick.count = (orb.enchants.brick.count || 1) + 1;
        }
        return true;
    }
    if (enchant.name === 'Brick Wall') {
        if (!orb.enchants.brickwall) {
            orb.enchants.brickwall = { ...enchant, count: 200 };
        } else {
            orb.enchants.brickwall.count = (orb.enchants.brickwall.count || 200) + 200;
        }
        return true;
    }

    if (type === 'allinone') {
        ['luck','speed','lighter','cloner','weird'].forEach(t => delete orb.enchants[t]);
        if (!orb.enchants.allinone || enchant.tier > orb.enchants.allinone.tier) {
            orb.enchants.allinone = enchant;
            return true;
        }
        return false;
    }

    if (['luck','speed','lighter','cloner','weird'].includes(type) && orb.enchants.allinone) {
        return false;
    }

    if (['luck','speed','lighter','cloner','weird'].includes(type)) {
        if (!orb.enchants[type] || enchant.tier > orb.enchants[type].tier) {
            orb.enchants[type] = enchant;
            return true;
        }
        return false;
    }

    const slotKey = 'e_' + enchant.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
    if (!orb.enchants[slotKey]) {
        orb.enchants[slotKey] = enchant;
        return true;
    }
    if (enchant.tier > orb.enchants[slotKey].tier) {
        orb.enchants[slotKey] = enchant;
        return true;
    }
    return false;
}

function toggleEquipOrb(index) {
    const orb = gameState.enchantOrbs[index];
    if (gameState.equippedOrb && gameState.equippedOrb.id === orb.id) {
        gameState.equippedOrb = null;
    } else {
        gameState.equippedOrb = orb;
    }
    saveGame();
    renderEnchantInventory();
    updateActiveEffectsBar();
}

function unequipOrb() {
    gameState.equippedOrb = null;
    saveGame();
    renderEnchantInventory();
    updateActiveEffectsBar();
}

// ============================================================
// ACTIVE EFFECTS BAR (unchanged)
// ============================================================
function updateActiveEffectsBar() {
    const bar = document.getElementById('activeEffectsBar');
    const bulkLabel = document.getElementById('bulkInfoLabel');
    if (!gameState.equippedOrb || Object.keys(gameState.equippedOrb.enchants).length === 0) {
        bar.style.display = 'none';
        bulkLabel.style.display = 'none';
        return;
    }
    const luck = getLuckMultiplier();
    const enchantLuck = getEnchantLuckMultiplier();
    const bulk = getBulkRolls();
    const { savedSeconds, isInstant } = getSpeedConfig();
    const duration = getRollDuration();

    let tags = '';
    const luckClass = luck >= 1 ? 'active-effect-tag' : 'active-effect-tag bad';
    tags += `<span class="${luckClass}">‚ö° Luck: ${luck >= 0 ? '+':''}${luck.toFixed(2)}x</span>`;

    if (isInstant) {
        tags += `<span class="active-effect-tag">‚ö° Speed: INSTANT</span>`;
    } else {
        const speedClass = duration <= BASE_ROLL_DURATION ? 'active-effect-tag' : 'active-effect-tag bad';
        tags += `<span class="${speedClass}">‚è± Roll time: ${(duration/1000).toFixed(2)}s</span>`;
    }

    const elClass = enchantLuck >= 1 ? 'active-effect-tag' : 'active-effect-tag bad';
    tags += `<span class="${elClass}">‚ú® Enchant luck: ${enchantLuck >= 0 ? '+':''}${enchantLuck.toFixed(2)}x</span>`;

    if (bulk > 1) {
        tags += `<span class="active-effect-tag">üìã Bulk rolls: ${bulk}</span>`;
    }

    if (gameState.brickCount > 0) {
        tags += `<span class="active-effect-tag">üß± Bricks: ${gameState.brickCount}</span>`;
    }

    bar.innerHTML = tags;
    bar.style.display = 'flex';

    if (bulk > 1) {
        const totalSlots = Math.max(20, Math.floor(bulk * 12.5));
        bulkLabel.textContent = `Bulk: ${bulk} acceptable slot${bulk > 1 ? 's' : ''} | Total track: ${totalSlots} slots`;
        bulkLabel.style.display = 'block';
    } else {
        bulkLabel.style.display = 'none';
    }
}

// ============================================================
// PERFORM ROLL (updated slot scaling)
// ============================================================
function performRoll() {
    if (gameState.isRolling) return;

    gameState.isRolling = true;
    document.getElementById('rollBtn').disabled = true;
    document.getElementById('acceptBtn').disabled = true;

    const rollTrack = document.getElementById('rollTrack');
    const rollDisplay = document.getElementById('rollDisplay');
    rollTrack.innerHTML = '';

    const buttonBoost = getButtonLuckBoost();
    const luckMult = getLuckMultiplier() * buttonBoost;
    const enchantLuckMult = getEnchantLuckMultiplier();
    const bulkRolls = getBulkRolls();

    if (gameState.equippedOrb && Object.values(gameState.equippedOrb.enchants).some(e => e.name === 'MYTHICAL')) {
        gameState.mythicalLuck = Math.random() ** -1;
        gameState.mythicalSecretLuck = 1 + Math.random() ** -1.5;
        gameState.mythicalBulk = 1 + Math.random() * 9;
    } else {
        gameState.mythicalLuck = 1;
        gameState.mythicalSecretLuck = 1;
        gameState.mythicalBulk = 1;
    }

    gameState.luckButtonClicks = 0;
    gameState.secretLuckButtonClicks = 0;
    document.getElementById('luckBoostDisplay').textContent = '';
    document.getElementById('secretLuckBoostDisplay').textContent = '';

    const totalSlots = Math.max(20, Math.floor(bulkRolls * 12.5));
    const acceptStart = Math.floor((totalSlots - bulkRolls) / 2);
    const acceptEnd = acceptStart + bulkRolls - 1;
    const centerAcceptable = Math.floor((acceptStart + acceptEnd) / 2);

    // Shrink slots based on bulk: scale = min(1, max(0.1, 3 / bulkRolls))
    const scale = Math.min(1, Math.max(0.1, 3 / bulkRolls));
    document.documentElement.style.setProperty('--slot-scale', scale);

    const slots = [];
    for (let i = 0; i < totalSlots; i++) {
        const isAcceptableSlot = (i >= acceptStart && i <= acceptEnd);
        slots.push(generateSlot(luckMult, enchantLuckMult, isAcceptableSlot));
    }

    gameState.pendingRolls = [];
    for (let i = acceptStart; i <= acceptEnd; i++) {
        gameState.pendingRolls.push(slots[i]);
    }

    gameState.stats.totalRolls++;

    slots.forEach((slot, idx) => {
        const isAcceptable = (idx >= acceptStart && idx <= acceptEnd);
        const isCenter = (idx === centerAcceptable);

        const square = document.createElement('div');
        square.className = 'roll-square';
        if (isAcceptable) square.classList.add('acceptable');
        if (isCenter) square.classList.add('center-acceptable');
        if (slot.isSecret) square.classList.add('secret-slot');
        if (slot.imaginary) square.classList.add('imaginary');
        if (slot.negative) square.classList.add('negative');

        let enchantHTML = '';
        if (slot.enchant) {
            enchantHTML = `<div class="enchant-indicator" style="padding:0;overflow:hidden;background:transparent;border:none;">
                ${enchantOrbHTML(slot.enchant, 25, '', slot.enchant.name)}
            </div>`;
        }

        let realHTML;
        if (slot.isEpilepsy) {
            realHTML = `${enchantHTML}<div class="rank-name"><span class="epilepsy-text">!! EPILEPSY !!</span></div><div class="rank-value">floor: ${slot.rawFloor.toLocaleString()}</div>`;
        } else if (slot.isHl3) {
            realHTML = `<div class="rank-name" style="position:absolute; top:0; left:0; width:100%; height:100%; background:url('public/images/nerd.png'); background-size:cover; background-repeat:no-repeat; background-position:center; border-radius:8px; z-index:1;"></div><div class="rank-value" style="position:relative; z-index:2; text-shadow:0 0 4px #000; margin-top:auto;">floor: ${slot.rawFloor.toLocaleString()}</div>`;
        } else if (slot.isBrogo) {
            realHTML = `<div class="rank-name" style="position:absolute; top:0; left:0; width:100%; height:100%; background:url('public/images/brogo.png'); background-size:cover; background-repeat:no-repeat; background-position:center; border-radius:8px; z-index:1;"></div><div class="rank-value" style="position:relative; z-index:2; text-shadow:0 0 4px #000; margin-top:auto;">floor: ${slot.rawFloor.toLocaleString()}</div>`;
        } else if (slot.isSecret) {
            const rarityClass = getRarityClass(slot.value);
            realHTML = `${enchantHTML}<div class="rank-name ${rarityClass}">${slot.secretDisplay || slot.value}</div><div class="rank-value">floor: ${slot.rawFloor.toLocaleString()}</div>`;
        } else {
            const rarityClass = getRarityClass(slot.value);
            const displayValue = slot.displayValue !== undefined ? slot.displayValue : slot.value;
            realHTML = `${enchantHTML}<div class="rank-name ${rarityClass}">${displayValue}</div><div class="rank-value">floor: ${slot.rawFloor.toLocaleString()}</div>`;
        }

        if (slot.isSecret && !slot.isDemonicSecret) {
            square.innerHTML = `<div class="secret-mystery-box"><span class="secret-mystery-q">?</span></div>`;
            square.dataset.realContent = realHTML;
            if (slot.isEpilepsy) square.classList.add('epilepsy-slot');
        } else {
            square.innerHTML = realHTML;
        }

        rollTrack.appendChild(square);
    });

    rollTrack.offsetHeight;
    rollDisplay.scrollLeft = 0;

    const rollDuration = getRollDuration();
    if (rollDuration === 0) {
        setTimeout(() => {
            rollTrack.querySelectorAll('.secret-slot').forEach(square => {
                if (square.dataset.realContent) {
                    square.innerHTML = square.dataset.realContent;
                    delete square.dataset.realContent;
                }
            });
            finishRoll();
        }, 10);
        return;
    }

    setTimeout(() => {
        const targetSquare = rollTrack.children[centerAcceptable];
        if (!targetSquare) { finishRoll(); return; }

        const centerSlot = slots[centerAcceptable];
        playRankSFX(centerSlot);

        const targetScrollLeft = targetSquare.offsetLeft - (rollDisplay.offsetWidth / 2) + (targetSquare.offsetWidth / 2);
        const startScrollLeft = 0;
        const distance = targetScrollLeft - startScrollLeft;
        const startTime = performance.now();

        function easeOutExpo(t) { return t === 1 ? 1 : 1 - Math.pow(2, -10 * t); }

        function animateScroll(now) {
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / rollDuration, 1);
            rollDisplay.scrollLeft = startScrollLeft + distance * easeOutExpo(progress);
            if (progress < 1) {
                requestAnimationFrame(animateScroll);
            } else {
                setTimeout(finishRoll, 100);
            }
        }
        requestAnimationFrame(animateScroll);
    }, 50);
}

function finishRoll() {
    const rollTrack = document.getElementById('rollTrack');
    rollTrack.querySelectorAll('.secret-slot').forEach(square => {
        if (square.dataset.realContent) {
            square.innerHTML = square.dataset.realContent;
            delete square.dataset.realContent;
        }
    });

    gameState.isRolling = false;
    document.getElementById('rollBtn').disabled = false;
    document.getElementById('acceptBtn').disabled = false;
    renderPendingPanel();
    saveGame();
    updateStats();
}

// ============================================================
// PENDING PANEL (unchanged)
// ============================================================
function renderPendingPanel() {
    const panel = document.getElementById('pendingPanel');
    const orbsDiv = document.getElementById('pendingPanelOrbs');

    if (!gameState.pendingRolls || gameState.pendingRolls.length === 0) {
        panel.classList.remove('visible');
        return;
    }

    const pendingEnchants = gameState.pendingRolls.filter(r => r.enchant).map(r => r.enchant);
    if (pendingEnchants.length === 0) {
        panel.classList.remove('visible');
        return;
    }

    let html = '';
    pendingEnchants.forEach(e => {
        html += enchantOrbHTML(e, 35, '', e.name);
        html += `<span style="font-size:0.8em;align-self:center;color:#ffd700;">${e.name}</span>`;
    });

    orbsDiv.innerHTML = html;
    panel.classList.add('visible');
}

// ============================================================
// ACCEPT ROLL (unchanged)
// ============================================================
function acceptRoll() {
    if (!gameState.pendingRolls || gameState.pendingRolls.length === 0) return;

    let added = 0;
    for (const slot of gameState.pendingRolls) {
        if (gameState.inventory.length >= MAX_INVENTORY) break;
        const invItem = { value: slot.value, timestamp: Date.now() + added };
        if (slot.isEpilepsy) invItem.isEpilepsy = true;
        if (slot.imaginary) invItem.imaginary = true;
        if (slot.negative) invItem.negative = true;
        gameState.inventory.push(invItem);
        gameState.stats.acceptedRanks++;
        if (!slot.isEpilepsy && !slot.isSecret) {
            gameState.stats.totalValue += slot.value;
            if (gameState.stats.highestRank === null || slot.value > gameState.stats.highestRank) {
                gameState.stats.highestRank = slot.value;
            }
        }
        added++;
    }

    if (gameState.inventory.length >= MAX_INVENTORY && added < gameState.pendingRolls.length) {
        alert('Inventory is full! Some ranks were not accepted.');
    }

    const pendingEnchants = gameState.pendingRolls.filter(r => r.enchant).map(r => r.enchant);

    for (const enchant of pendingEnchants) {
        if (enchant.type === 'joke' && enchant.name === 'Brick') {
            gameState.brickCount++;
            document.getElementById('brickStatBox').style.display = '';
            document.getElementById('brickCount').textContent = gameState.brickCount;
        }
        if (enchant.name === 'Brick Wall') {
            gameState.brickCount += 200;
            document.getElementById('brickStatBox').style.display = '';
            document.getElementById('brickCount').textContent = gameState.brickCount;
        }

        if (gameState.enchantOrbs.length < MAX_ENCHANTS) {
            const newOrb = createEnchantOrb();
            addEnchantToOrb(newOrb, enchant);
            gameState.enchantOrbs.push(newOrb);
        }
    }

    gameState.pendingRolls = [];

    document.getElementById('acceptBtn').disabled = true;
    document.getElementById('pendingPanel').classList.remove('visible');

    saveGame();
    renderInventory();
    renderEnchantInventory();
    updateStats();
    updateActiveEffectsBar();
}

// ============================================================
// RENDER INVENTORY (unchanged)
// ============================================================
function renderInventory() {
    const grid = document.getElementById('inventoryGrid');
    grid.innerHTML = '';
    const startIndex = (gameState.currentPage - 1) * ITEMS_PER_PAGE;

    for (let i = 0; i < ITEMS_PER_PAGE; i++) {
        const actualIndex = startIndex + i;
        const slot = document.createElement('div');
        slot.className = 'inventory-slot';

        if (actualIndex < gameState.inventory.length) {
            const item = gameState.inventory[actualIndex];
            let displayValue = item.value;
            if (item.negative) displayValue = -displayValue;
            if (item.imaginary) displayValue = displayValue + 'i';
            if (item.isEpilepsy) {
                slot.classList.add('epilepsy-inv');
                slot.innerHTML = `<div class="slot-value"><span class="epilepsy-text" style="font-size:0.55em;">!! EPILEPSY !!</span></div>`;
            } else if (item.isHl3) {
                slot.innerHTML = `<div class="slot-value" style="position:absolute; top:0; left:0; width:100%; height:100%; background:url('public/images/nerd.png'); background-size:cover; background-repeat:no-repeat; background-position:center; border-radius:6px;"></div><div style="position:relative; z-index:2; font-size:0.5em; margin-top:auto; text-shadow:0 0 2px #000;">-0.03</div>`;
            } else if (item.isBrogo) {
                slot.innerHTML = `<div class="slot-value" style="position:absolute; top:0; left:0; width:100%; height:100%; background:url('public/images/brogo.png'); background-size:cover; background-repeat:no-repeat; background-position:center; border-radius:6px;"></div><div style="position:relative; z-index:2; font-size:0.5em; margin-top:auto; text-shadow:0 0 2px #000;">-0.02</div>`;
            } else {
                const rarityClass = getRarityClass(item.value);
                slot.innerHTML = `<div class="slot-value ${rarityClass}">${displayValue}</div>`;
            }
            if (item.imaginary) slot.classList.add('imaginary');
            if (item.negative) slot.classList.add('negative');

            if (gameState.bulkDeleteMode) {
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.className = 'delete-checkbox';
                cb.checked = gameState.selectedInventoryIndices.includes(actualIndex);
                cb.addEventListener('click', (e) => e.stopPropagation());
                cb.addEventListener('change', (e) => {
                    if (cb.checked) {
                        if (!gameState.selectedInventoryIndices.includes(actualIndex)) {
                            gameState.selectedInventoryIndices.push(actualIndex);
                        }
                    } else {
                        gameState.selectedInventoryIndices = gameState.selectedInventoryIndices.filter(idx => idx !== actualIndex);
                    }
                });
                slot.appendChild(cb);
                slot.onclick = (e) => {
                    if (e.target !== cb) {
                        cb.checked = !cb.checked;
                        cb.dispatchEvent(new Event('change'));
                    }
                };
            } else {
                slot.onclick = () => openDeleteModal(actualIndex);
            }
        } else {
            slot.classList.add('empty');
            slot.innerHTML = '<div style="opacity:0.3;">Empty</div>';
        }
        grid.appendChild(slot);
    }
    updatePaginationControls();
}

function updatePaginationControls() {
    document.getElementById('currentPage').textContent = gameState.currentPage;
    document.getElementById('prevBtn').disabled = gameState.currentPage === 1;
    document.getElementById('nextBtn').disabled = gameState.currentPage === TOTAL_PAGES;
}

function changePage(direction) {
    const newPage = gameState.currentPage + direction;
    if (newPage >= 1 && newPage <= TOTAL_PAGES) {
        gameState.currentPage = newPage;
        renderInventory();
        saveGame();
    }
}

function sortInventory(method) {
    switch(method) {
        case 'value-desc': gameState.inventory.sort((a,b) => b.value - a.value); break;
        case 'value-asc':  gameState.inventory.sort((a,b) => a.value - b.value); break;
        case 'newest':     gameState.inventory.sort((a,b) => b.timestamp - a.timestamp); break;
        case 'oldest':     gameState.inventory.sort((a,b) => a.timestamp - b.timestamp); break;
    }
    renderInventory();
    saveGame();
}

// ============================================================
// RENDER ENCHANT INVENTORY (unchanged)
// ============================================================
function renderEnchantInventory() {
    const grid = document.getElementById('enchantGrid');
    grid.innerHTML = '';
    const startIndex = (gameState.currentEnchantPage - 1) * ENCHANTS_PER_PAGE;

    for (let i = 0; i < ENCHANTS_PER_PAGE; i++) {
        const actualIndex = startIndex + i;
        const slot = document.createElement('div');
        slot.className = 'enchant-slot';

        if (actualIndex < gameState.enchantOrbs.length) {
            const orb = gameState.enchantOrbs[actualIndex];
            const isEquipped = gameState.equippedOrb && gameState.equippedOrb.id === orb.id;
            const isSelectedForMerge = gameState.mergeSelection.includes(orb.id);
            const isLocked = !!orb.locked;

            if (isEquipped && !gameState.mergeModeActive) slot.classList.add('equipped');
            if (isSelectedForMerge) slot.classList.add('selected-for-merge');
            if (isLocked) slot.classList.add('locked');

            const equippedBadge = (isEquipped && !gameState.mergeModeActive) ? '<div class="equipped-badge">EQUIPPED</div>' : '';
            const lockedBadge = isLocked ? '<div class="locked-badge">üîí MERGED</div>' : '';
            const mergeBadge = isSelectedForMerge ? '<div class="equipped-badge" style="background:#f59e0b;color:#000;">SELECTED</div>' : '';

            let enchantsHTML = orbEnchantsHTML(orb);

            if (gameState.bulkDeleteEnchantMode) {
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.className = 'delete-checkbox';
                cb.checked = gameState.selectedEnchantIndices.includes(actualIndex);
                cb.addEventListener('click', (e) => e.stopPropagation());
                cb.addEventListener('change', (e) => {
                    if (cb.checked) {
                        if (!gameState.selectedEnchantIndices.includes(actualIndex)) {
                            gameState.selectedEnchantIndices.push(actualIndex);
                        }
                    } else {
                        gameState.selectedEnchantIndices = gameState.selectedEnchantIndices.filter(idx => idx !== actualIndex);
                    }
                });
                slot.innerHTML = '';
                slot.appendChild(cb);
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = `${equippedBadge}${lockedBadge}${mergeBadge}<div style="font-weight:bold;margin-bottom:5px;font-size:0.9em;">Enchant Orb</div>${enchantsHTML}<button class="delete-orb-btn" onclick="event.stopPropagation();openDeleteEnchantModal(${actualIndex})">Delete</button>`;
                slot.appendChild(contentDiv);
                slot.onclick = (e) => {
                    if (e.target !== cb && !e.target.classList.contains('delete-orb-btn')) {
                        cb.checked = !cb.checked;
                        cb.dispatchEvent(new Event('change'));
                    }
                };
            } else {
                slot.innerHTML = `${equippedBadge}${lockedBadge}${mergeBadge}<div style="font-weight:bold;margin-bottom:5px;font-size:0.9em;">Enchant Orb</div>${enchantsHTML}<button class="delete-orb-btn" onclick="event.stopPropagation();openDeleteEnchantModal(${actualIndex})">Delete</button>`;
                if (gameState.mergeModeActive) {
                    if (!isLocked) {
                        slot.onclick = () => { event.stopPropagation(); selectForMerge(orb.id); };
                        slot.title = isSelectedForMerge ? 'Click to deselect' : 'Click to select for merge';
                    } else {
                        slot.style.cursor = 'not-allowed';
                        slot.title = 'Merged orbs cannot be merged again';
                    }
                } else {
                    slot.onclick = () => toggleEquipOrb(actualIndex);
                }
            }
        } else {
            slot.classList.add('empty');
            slot.innerHTML = '<div style="opacity:0.3;">Empty</div>';
        }
        grid.appendChild(slot);
    }

    updateEnchantPaginationControls();
    renderEquippedEnchants();
}

function updateEnchantPaginationControls() {
    document.getElementById('currentEnchantPage').textContent = gameState.currentEnchantPage;
    document.getElementById('prevEnchantBtn').disabled = gameState.currentEnchantPage === 1;
    document.getElementById('nextEnchantBtn').disabled = gameState.currentEnchantPage === TOTAL_ENCHANT_PAGES;
}

function changeEnchantPage(direction) {
    const newPage = gameState.currentEnchantPage + direction;
    if (newPage >= 1 && newPage <= TOTAL_ENCHANT_PAGES) {
        gameState.currentEnchantPage = newPage;
        renderEnchantInventory();
        saveGame();
    }
}

function sortEnchants(method) {
    function getMaxTier(orb) {
        let max = 0;
        Object.values(orb.enchants).forEach(e => { if ((e.tier || 0) > max) max = e.tier; });
        return max;
    }
    function getFirstType(orb) {
        const keys = Object.keys(orb.enchants);
        return keys.length > 0 ? (orb.enchants[keys[0]].type || '') : '';
    }

    switch(method) {
        case 'tier-desc': gameState.enchantOrbs.sort((a,b) => getMaxTier(b) - getMaxTier(a)); break;
        case 'tier-asc':  gameState.enchantOrbs.sort((a,b) => getMaxTier(a) - getMaxTier(b)); break;
        case 'type':      gameState.enchantOrbs.sort((a,b) => getFirstType(a).localeCompare(getFirstType(b))); break;
        case 'newest':    gameState.enchantOrbs.sort((a,b) => b.timestamp - a.timestamp); break;
    }
    renderEnchantInventory();
    saveGame();
}

function renderEquippedEnchants() {
    const grid = document.getElementById('equippedGrid');
    grid.innerHTML = '';

    const slot = document.createElement('div');
    slot.className = 'equipped-slot';

    if (gameState.equippedOrb) {
        const orb = gameState.equippedOrb;
        slot.innerHTML = `
            <div style="font-weight:bold;margin-bottom:5px;font-size:0.9em;">Equipped Orb</div>
            ${orbEnchantsHTML(orb)}
            <div style="font-size:0.75em;opacity:0.6;margin-top:6px;">Click to unequip</div>
        `;
        slot.onclick = () => unequipOrb();
    } else {
        slot.classList.add('empty');
        slot.innerHTML = '<div style="opacity:0.3;">No Orb Equipped</div>';
    }

    grid.appendChild(slot);
}

// ============================================================
// MODAL (unchanged)
// ============================================================
function openDeleteModal(index) {
    gameState.deleteIndex = index;
    gameState.deleteEnchantIndex = null;
    const item = gameState.inventory[index];
    let display = item.value;
    if (item.negative) display = -display;
    if (item.imaginary) display = display + 'i';
    document.getElementById('deleteRankValue').textContent = `rank ${display}`;
    document.getElementById('deleteModal').classList.add('show');
}

function openDeleteEnchantModal(index) {
    gameState.deleteEnchantIndex = index;
    gameState.deleteIndex = null;
    const orb = gameState.enchantOrbs[index];
    const names = Object.values(orb.enchants).map(e => e.name).join(' + ') || 'empty orb';
    document.getElementById('deleteRankValue').textContent = `Orb (${names})`;
    document.getElementById('deleteModal').classList.add('show');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('show');
    gameState.deleteIndex = null;
    gameState.deleteEnchantIndex = null;
}

function confirmDelete() {
    if (gameState.deleteEnchantIndex !== null) {
        const orb = gameState.enchantOrbs[gameState.deleteEnchantIndex];
        if (gameState.equippedOrb && gameState.equippedOrb.id === orb.id) {
            gameState.equippedOrb = null;
        }
        gameState.enchantOrbs.splice(gameState.deleteEnchantIndex, 1);
        renderEnchantInventory();
        updateActiveEffectsBar();
        saveGame();
    } else if (gameState.deleteIndex !== null) {
        gameState.inventory.splice(gameState.deleteIndex, 1);
        gameState.stats.acceptedRanks = gameState.inventory.length;
        gameState.stats.totalValue = gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).reduce((s, it) => s + it.value, 0);
        gameState.stats.highestRank = gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).length > 0
            ? Math.max(...gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).map(it => it.value))
            : null;
        renderInventory();
        updateStats();
        saveGame();
    }
    closeDeleteModal();
}

// ============================================================
// STATS (unchanged)
// ============================================================
function updateStats() {
    document.getElementById('totalRolls').textContent = gameState.stats.totalRolls;
    document.getElementById('acceptedRanks').textContent = gameState.stats.acceptedRanks;
    document.getElementById('highestRank').textContent =
        gameState.stats.highestRank !== null ? gameState.stats.highestRank : '-';
    const avg = gameState.inventory.length > 0
        ? (gameState.stats.totalValue / gameState.inventory.length).toFixed(2)
        : '-';
    document.getElementById('avgRank').textContent = avg;
    if (gameState.brickCount > 0) {
        document.getElementById('brickStatBox').style.display = '';
        document.getElementById('brickCount').textContent = gameState.brickCount;
    }
}

// ============================================================
// ENCHANT INDEX TOGGLE (unchanged)
// ============================================================
function toggleEnchantType(type) {
    const content = document.getElementById(`${type}-content`);
    const toggle = document.getElementById(`${type}-toggle`);
    if (!content || !toggle) return;
    if (content.classList.contains('open')) {
        content.classList.remove('open');
        toggle.textContent = '‚ñº';
    } else {
        content.classList.add('open');
        toggle.textContent = '‚ñ≤';
    }
}

function toggleJokeEnchants(enabled) {
    gameState.jokeEnchantsEnabled = enabled;
    document.getElementById('jokeToggleStatus').textContent = enabled ? 'ON' : 'OFF';
    document.getElementById('jokeToggleStatus').style.color = enabled ? '#ffd700' : '#aaa';
    saveGame();
}

// ============================================================
// SAVE / LOAD (unchanged)
// ============================================================
function saveGame() {
    try {
        localStorage.setItem('logmaRNGame', JSON.stringify(gameState));
    } catch(e) { }
}

function loadGame() {
    try {
        const saved = localStorage.getItem('logmaRNGame');
        if (saved) {
            const d = JSON.parse(saved);
            gameState.inventory = d.inventory || [];
            gameState.enchantOrbs = d.enchantOrbs || [];
            gameState.equippedOrb = d.equippedOrb || null;
            gameState.stats = d.stats || { totalRolls:0, acceptedRanks:0, highestRank:null, totalValue:0 };
            gameState.currentPage = d.currentPage || 1;
            gameState.currentEnchantPage = d.currentEnchantPage || 1;
            gameState.jokeEnchantsEnabled = d.jokeEnchantsEnabled || false;
            gameState.brickCount = d.brickCount || 0;
            gameState.luckButtonClicks = 0;
            gameState.secretLuckButtonClicks = 0;
        }
    } catch(e) { }

    gameState.pendingRolls = [];
    gameState.mergeSelection = [];
    gameState.mergeModeActive = false;
    gameState.bulkDeleteMode = false;
    gameState.bulkDeleteEnchantMode = false;
    gameState.selectedInventoryIndices = [];
    gameState.selectedEnchantIndices = [];
    gameState.isRolling = false;
    gameState.deleteIndex = null;
    gameState.deleteEnchantIndex = null;

    document.getElementById('jokeToggleSwitch').checked = gameState.jokeEnchantsEnabled;
    document.getElementById('jokeToggleStatus').textContent = gameState.jokeEnchantsEnabled ? 'ON' : 'OFF';
    document.getElementById('jokeToggleStatus').style.color = gameState.jokeEnchantsEnabled ? '#ffd700' : '#aaa';

    if (gameState.brickCount > 0) {
        document.getElementById('brickStatBox').style.display = '';
    }

    const avariceOrb = document.getElementById('avariceIndexOrb');
    if (avariceOrb) {
        avariceOrb.style.width = '56px';
        avariceOrb.style.height = '56px';
        avariceOrb.innerHTML = getAvariceSVG(56);
    }

    renderInventory();
    renderEnchantInventory();
    updateStats();
    updateActiveEffectsBar();
}

// ============================================================
// MERGE LOGIC (updated for Alpha)
// ============================================================
function toggleMergeMode() {
    gameState.mergeModeActive = !gameState.mergeModeActive;
    if (!gameState.mergeModeActive) {
        gameState.mergeSelection = [];
        renderMergePanel();
    }
    const btn = document.getElementById('mergeModeBtn');
    btn.textContent = 'üîÄ Merge Mode: ' + (gameState.mergeModeActive ? 'ON' : 'OFF');
    btn.classList.toggle('active', gameState.mergeModeActive);
    renderEnchantInventory();
}

function cancelMerge() {
    gameState.mergeSelection = [];
    renderMergePanel();
    renderEnchantInventory();
}

function selectForMerge(orbId) {
    const idx = gameState.mergeSelection.indexOf(orbId);
    if (idx >= 0) {
        gameState.mergeSelection.splice(idx, 1);
    } else if (gameState.mergeSelection.length < 2) {
        gameState.mergeSelection.push(orbId);
    }
    renderMergePanel();
    renderEnchantInventory();
}

function findMergeCostItem() {
    let best = null;
    let bestIdx = -1;
    gameState.inventory.forEach((item, i) => {
        if (item.isEpilepsy) return;
        if (item.value >= 6) {
            if (best === null || item.value < best.value) {
                best = item; bestIdx = i;
            }
        }
    });
    return { item: best, index: bestIdx };
}

function renderMergePanel() {
    const panel = document.getElementById('mergePanel');
    const preview = document.getElementById('mergeOrbsPreview');
    const costInfo = document.getElementById('mergeCostInfo');
    const mergeBtn = document.getElementById('doMergeBtn');

    if (gameState.mergeSelection.length === 0) {
        panel.classList.remove('visible');
        return;
    }
    panel.classList.add('visible');

    let previewHTML = '';
    gameState.mergeSelection.forEach(id => {
        const orb = gameState.enchantOrbs.find(o => o.id === id);
        if (!orb) return;
        previewHTML += `<div class="merge-orb-preview">
            <div style="font-size:0.8em;margin-bottom:6px;opacity:0.7;">Orb</div>
            ${orbEnchantsHTML(orb)}
        </div>`;
    });

    if (gameState.mergeSelection.length === 1) {
        previewHTML += `<div style="opacity:0.5;font-size:0.85em;">Select one more orb‚Ä¶</div>`;
    } else if (gameState.mergeSelection.length === 2) {
        previewHTML += `<div style="font-size:1.5em;">‚Üí</div>
        <div class="merge-orb-preview">
            <div style="font-size:0.8em;margin-bottom:6px;color:#f59e0b;">Merged</div>
            ${getMergePreviewHTML()}
        </div>`;
    }
    preview.innerHTML = previewHTML;

    const { item } = findMergeCostItem();
    if (gameState.mergeSelection.length === 2) {
        if (item) {
            costInfo.className = 'merge-cost-info';
            costInfo.textContent = `Cost: rank ${item.value} (lowest ‚â•6 in inventory)`;
            mergeBtn.disabled = false;
        } else {
            costInfo.className = 'merge-cost-info no-cost';
            costInfo.textContent = 'Need at least one rank ‚â• 6 in inventory to merge!';
            mergeBtn.disabled = true;
        }
    } else {
        costInfo.textContent = '';
        mergeBtn.disabled = true;
    }
}

function getMergePreviewHTML() {
    const mergedEnchants = buildMergedEnchants();
    const fakeOrb = { enchants: mergedEnchants };
    return orbEnchantsHTML(fakeOrb);
}

function buildMergedEnchants() {
    const merged = {};
    gameState.mergeSelection.forEach(id => {
        const orb = gameState.enchantOrbs.find(o => o.id === id);
        if (!orb) return;
        Object.entries(orb.enchants).forEach(([key, enchant]) => {
            if (!merged[key]) {
                merged[key] = { ...enchant };
            } else {
                if (key === 'brick') {
                    merged[key].count = (merged[key].count || 1) + (enchant.count || 1);
                } else if (key === 'brickwall') {
                    merged[key].count = (merged[key].count || 200) + (enchant.count || 200);
                } else {
                    let dupKey = key + '_2';
                    let n = 2;
                    while (merged[dupKey]) { n++; dupKey = key + '_' + n; }
                    merged[dupKey] = { ...enchant };
                }
            }
        });
    });
    return merged;
}

function performMerge() {
    if (gameState.mergeSelection.length !== 2) return;
    const { item, index } = findMergeCostItem();
    if (!item) return;

    const horseKey = 'e_h_o_r_s_e';
    const alphaKey = 'e_alpha';
    let hasHorseBoth = true;
    let hasAlphaBoth = true;
    const orb1 = gameState.enchantOrbs.find(o => o.id === gameState.mergeSelection[0]);
    const orb2 = gameState.enchantOrbs.find(o => o.id === gameState.mergeSelection[1]);
    if (!orb1 || !orb2) return;
    if (!orb1.enchants[horseKey] || !orb2.enchants[horseKey]) {
        hasHorseBoth = false;
    }
    if (!orb1.enchants[alphaKey] || !orb2.enchants[alphaKey]) {
        hasAlphaBoth = false;
    }

    const mergedEnchants = buildMergedEnchants();
    const newOrb = {
        id: Date.now() + Math.random(),
        enchants: mergedEnchants,
        timestamp: Date.now(),
        locked: !(hasHorseBoth || hasAlphaBoth)
    };

    const removedIds = [...gameState.mergeSelection];
    gameState.enchantOrbs = gameState.enchantOrbs.filter(o => !removedIds.includes(o.id));

    if (gameState.equippedOrb && removedIds.includes(gameState.equippedOrb.id)) {
        gameState.equippedOrb = null;
    }

    if (gameState.enchantOrbs.length < MAX_ENCHANTS) {
        gameState.enchantOrbs.push(newOrb);
    }

    gameState.inventory.splice(index, 1);
    gameState.stats.acceptedRanks = gameState.inventory.length;
    gameState.stats.totalValue = gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).reduce((s, i) => s + i.value, 0);
    gameState.stats.highestRank = gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).length > 0
        ? Math.max(...gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).map(i => i.value))
        : null;

    gameState.mergeSelection = [];
    gameState.mergeModeActive = false;
    const btn = document.getElementById('mergeModeBtn');
    btn.textContent = 'üîÄ Merge Mode: OFF';
    btn.classList.remove('active');

    saveGame();
    renderInventory();
    renderEnchantInventory();
    renderMergePanel();
    updateStats();
    updateActiveEffectsBar();
}

// ============================================================
// BULK DELETE FUNCTIONS (unchanged)
// ============================================================
function toggleBulkDeleteMode() {
    gameState.bulkDeleteMode = !gameState.bulkDeleteMode;
    if (!gameState.bulkDeleteMode) {
        gameState.selectedInventoryIndices = [];
    }
    document.getElementById('bulkDeleteBar').style.display = gameState.bulkDeleteMode ? 'flex' : 'none';
    document.getElementById('bulkDeleteModeBtn').textContent = 'üóëÔ∏è Bulk Delete: ' + (gameState.bulkDeleteMode ? 'ON' : 'OFF');
    renderInventory();
}

function toggleBulkDeleteEnchantMode() {
    gameState.bulkDeleteEnchantMode = !gameState.bulkDeleteEnchantMode;
    if (!gameState.bulkDeleteEnchantMode) {
        gameState.selectedEnchantIndices = [];
    }
    document.getElementById('bulkDeleteEnchantBar').style.display = gameState.bulkDeleteEnchantMode ? 'flex' : 'none';
    document.getElementById('bulkDeleteEnchantModeBtn').textContent = 'üóëÔ∏è Bulk Delete Ench: ' + (gameState.bulkDeleteEnchantMode ? 'ON' : 'OFF');
    renderEnchantInventory();
}

function deleteSelectedInventory() {
    if (gameState.selectedInventoryIndices.length === 0) return;
    const toDelete = [...gameState.selectedInventoryIndices].sort((a,b) => b - a);
    for (let idx of toDelete) {
        gameState.inventory.splice(idx, 1);
    }
    gameState.selectedInventoryIndices = [];
    gameState.stats.acceptedRanks = gameState.inventory.length;
    gameState.stats.totalValue = gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).reduce((s, i) => s + i.value, 0);
    gameState.stats.highestRank = gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).length > 0
        ? Math.max(...gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).map(i => i.value))
        : null;
    renderInventory();
    updateStats();
    saveGame();
}

function deleteUnderThreshold() {
    const threshold = parseFloat(document.getElementById('thresholdInput').value);
    if (isNaN(threshold)) return;
    const excludeSecrets = document.getElementById('excludeSecretsCheckbox').checked;
    const newInventory = [];
    for (let i = 0; i < gameState.inventory.length; i++) {
        const item = gameState.inventory[i];
        let effectiveValue = item.value;
        if (item.negative) effectiveValue = -effectiveValue;
        if (effectiveValue <= threshold && !(excludeSecrets && (item.isEpilepsy || item.isSecret))) {
            continue;
        }
        newInventory.push(item);
    }
    gameState.inventory = newInventory;
    gameState.selectedInventoryIndices = [];
    gameState.stats.acceptedRanks = gameState.inventory.length;
    gameState.stats.totalValue = gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).reduce((s, i) => s + i.value, 0);
    gameState.stats.highestRank = gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).length > 0
        ? Math.max(...gameState.inventory.filter(i => !i.isEpilepsy && !i.isSecret).map(i => i.value))
        : null;
    renderInventory();
    updateStats();
    saveGame();
}

function deleteSelectedEnchants() {
    if (gameState.selectedEnchantIndices.length === 0) return;
    const toDelete = [...gameState.selectedEnchantIndices].sort((a,b) => b - a);
    for (let idx of toDelete) {
        const orb = gameState.enchantOrbs[idx];
        if (gameState.equippedOrb && gameState.equippedOrb.id === orb.id) {
            gameState.equippedOrb = null;
        }
        gameState.enchantOrbs.splice(idx, 1);
    }
    gameState.selectedEnchantIndices = [];
    renderEnchantInventory();
    updateActiveEffectsBar();
    saveGame();
}

// ============================================================
// EVENT LISTENERS
// ============================================================
document.getElementById('rollBtn').addEventListener('click', performRoll);
document.getElementById('acceptBtn').addEventListener('click', acceptRoll);

loadGame();
</script>

</body>
</html>